### 7.6.1 Usando myisamchk para Recuperação de Crash

Esta seção descreve como verificar e lidar com a corrupção de dados em Databases MySQL. Se suas tables se corromperem frequentemente, você deve tentar encontrar o motivo. Consulte a Seção B.3.3.3, “O Que Fazer Se o MySQL Continuar a Ter Crashs”.

Para uma explicação de como tables `MyISAM` podem ser corrompidas, consulte a Seção 15.2.4, “Problemas em Tables MyISAM”.

Se você executar o **mysqld** com o locking externo desabilitado (que é o padrão), você não pode usar o **myisamchk** de forma confiável para verificar uma table enquanto o **mysqld** estiver usando a mesma table. Se você puder ter certeza de que ninguém pode acessar as tables através do **mysqld** enquanto executa o **myisamchk**, você só precisa executar **mysqladmin flush-tables** antes de iniciar a verificação das tables. Se você não puder garantir isso, você deve parar o **mysqld** enquanto verifica as tables. Se você executar o **myisamchk** para verificar tables que o **mysqld** está atualizando ao mesmo tempo, você pode receber um aviso de que uma table está corrompida mesmo quando não estiver.

Se o servidor for executado com o locking externo habilitado, você pode usar o **myisamchk** para verificar tables a qualquer momento. Neste caso, se o servidor tentar atualizar uma table que o **myisamchk** está usando, o servidor espera o **myisamchk** terminar antes de continuar.

Se você usar o **myisamchk** para reparar ou otimizar tables, você *deve* sempre garantir que o servidor **mysqld** não esteja usando a table (isso também se aplica se o locking externo estiver desabilitado). Se você não parar o **mysqld**, você deve pelo menos executar um **mysqladmin flush-tables** antes de rodar o **myisamchk**. Suas tables *podem ficar corrompidas* se o servidor e o **myisamchk** acessarem as tables simultaneamente.

Ao realizar a recuperação de crash, é importante entender que cada table `MyISAM` *`tbl_name`* em um Database corresponde aos três arquivos no diretório do Database, conforme mostrado na tabela a seguir.

<table summary="Os três arquivos no diretório do Database que correspondem a cada table MyISAM."><col style="width: 20%"/><col style="width: 40%"/><thead><tr> <th>Arquivo</th> <th>Propósito</th> </tr></thead><tbody><tr> <td><code><em><code>tbl_name</code></em>.frm</code></td> <td>Arquivo de Definição (formato)</td> </tr><tr> <td><code><em><code>tbl_name</code></em>.MYD</code></td> <td>Arquivo de Dados (Data file)</td> </tr><tr> <td><code><em><code>tbl_name</code></em>.MYI</code></td> <td>Arquivo de Index (Index file)</td> </tr> </tbody></table>

Cada um desses três tipos de arquivo está sujeito à corrupção de várias maneiras, mas os problemas ocorrem com mais frequência nos Arquivos de Dados (Data files) e Arquivos de Index (Index files).

O **myisamchk** funciona criando uma cópia do Arquivo de Dados (Data file) `.MYD` linha por linha. Ele encerra o estágio de reparo removendo o antigo arquivo `.MYD` e renomeando o novo arquivo para o nome original. Se você usar `--quick`, o **myisamchk** não cria um arquivo `.MYD` temporário, mas, em vez disso, assume que o arquivo `.MYD` está correto e gera apenas um novo arquivo de Index sem tocar no arquivo `.MYD`. Isso é seguro, porque o **myisamchk** detecta automaticamente se o arquivo `.MYD` está corrompido e aborta o reparo, se for o caso. Você também pode especificar a opção `--quick` duas vezes para o **myisamchk**. Neste caso, o **myisamchk** não aborta em alguns erros (como erros de duplicate-key) mas tenta resolvê-los modificando o arquivo `.MYD`. Normalmente, o uso de duas opções `--quick` é útil apenas se você tiver pouco espaço livre em disco para realizar um reparo normal. Neste caso, você deve pelo menos fazer um backup da table antes de executar o **myisamchk**.