### 14.8.5 Configurando Concorrência de Fila para InnoDB

O `InnoDB` utiliza threads do sistema operacional para processar solicitações de transações do usuário. (As transações podem emitir muitas solicitações ao `InnoDB` antes de comprometer ou reverter.) Em sistemas operacionais e servidores modernos com processadores multi-core, onde a alternância de contexto é eficiente, a maioria das cargas de trabalho funciona bem sem qualquer limite no número de threads concorrentes. As melhorias na escalabilidade do MySQL 5.5 e versões posteriores reduzem a necessidade de limitar o número de threads que estão executando simultaneamente dentro do `InnoDB`.

Em situações em que é útil minimizar a alternância de contexto entre os threads, o `InnoDB` pode usar várias técnicas para limitar o número de threads do sistema operacional que estão executando simultaneamente (e, portanto, o número de solicitações que são processadas em um único momento). Quando o `InnoDB` recebe uma nova solicitação de uma sessão do usuário, se o número de threads que estão executando simultaneamente estiver em um limite pré-definido, a nova solicitação dorme por um curto período antes de tentar novamente. Os threads que estão esperando por bloqueios não são contados no número de threads que estão executando simultaneamente.

Você pode limitar o número de threads concorrentes definindo o parâmetro de configuração `innodb_thread_concurrency`. Quando o número de threads em execução atinge esse limite, os threads adicionais ficam em espera por um número de microsegundos, definido pelo parâmetro de configuração `innodb_thread_sleep_delay`, antes de serem colocados na fila.

Anteriormente, era necessário experimentar para encontrar o valor ótimo para `innodb_thread_sleep_delay`, e o valor ótimo poderia mudar dependendo da carga de trabalho. No MySQL 5.6.3 e versões superiores, você pode definir a opção de configuração `innodb_adaptive_max_sleep_delay` para o valor máximo que você permitiria para `innodb_thread_sleep_delay`, e o `InnoDB` ajusta automaticamente `innodb_thread_sleep_delay` para cima ou para baixo, dependendo da atividade atual de agendamento de threads. Esse ajuste dinâmico ajuda o mecanismo de agendamento de threads a funcionar de forma suave em momentos em que o sistema está levemente carregado e quando está operando próximo à capacidade máxima.

O valor padrão para `innodb_thread_concurrency` e o limite padrão implícito no número de threads concorrentes foram alterados em várias versões do MySQL e do `InnoDB`. O valor padrão de `innodb_thread_concurrency` é `0`, de modo que, por padrão, não há limite no número de threads que podem ser executados simultaneamente.

O `InnoDB` faz com que os threads durmam apenas quando o número de threads concorrentes é limitado. Quando não há limite no número de threads, todos competem igualmente para serem agendados. Ou seja, se `innodb_thread_concurrency` é `0`, o valor de `innodb_thread_sleep_delay` é ignorado.

Quando há um limite no número de threads (quando `innodb_thread_concurrency` é > 0), o `InnoDB` reduz o custo de alternância de contexto ao permitir que múltiplos pedidos feitos durante a execução de uma única instrução SQL entrem no `InnoDB` sem observar o limite definido por `innodb_thread_concurrency`. Como uma instrução SQL (como uma junção) pode incluir múltiplas operações de linha no `InnoDB`, o `InnoDB` atribui um número especificado de "ingressos" que permitem que um thread seja agendado repetidamente com um custo mínimo.

Quando uma nova instrução SQL começa, um thread não tem tickets e deve observar `innodb_thread_concurrency`. Uma vez que o thread tenha direito de entrar no `InnoDB`, ele recebe um número de tickets que pode usar para entrar no `InnoDB` posteriormente para realizar operações de linha. Se os tickets acabarem, o thread é expulso e `innodb_thread_concurrency` é observado novamente, o que pode colocar o thread de volta na fila de threads em espera, de primeiro a entrar, de primeiro a sair. Quando o thread tiver direito de entrar no `InnoDB` novamente, os tickets são atribuídos novamente. O número de tickets atribuídos é especificado pela opção global `innodb_concurrency_tickets`, que é 5000 por padrão. Um thread que está esperando por um bloqueio recebe um ticket assim que o bloqueio estiver disponível.

Os valores corretos dessas variáveis dependem do seu ambiente e da carga de trabalho. Experimente uma variedade de valores diferentes para determinar qual valor funciona melhor para suas aplicações. Antes de limitar o número de threads que podem ser executadas simultaneamente, revise as opções de configuração que podem melhorar o desempenho do `InnoDB` em computadores com múltiplos núcleos e processadores, como `innodb_adaptive_hash_index`.

Para obter informações gerais sobre o desempenho do gerenciamento de threads do MySQL, consulte a Seção 5.1.11.1, “Interfaces de Conexão”.
