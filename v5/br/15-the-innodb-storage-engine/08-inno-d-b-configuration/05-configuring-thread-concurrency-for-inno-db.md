### 14.8.5 Configurando a Concorrência de Thread para InnoDB

O `InnoDB` utiliza threads do sistema operacional para processar solicitações de transações de usuário. (As transações podem emitir muitas solicitações ao `InnoDB` antes de fazerem commit ou rollback.) Em sistemas operacionais modernos e servidores com processadores multi-core, onde a comutação de contexto (context switching) é eficiente, a maioria das cargas de trabalho funciona bem sem qualquer limite no número de threads concorrentes. As melhorias de escalabilidade no MySQL 5.5 e superior reduzem a necessidade de limitar o número de threads sendo executados concorrentemente dentro do `InnoDB`.

Em situações onde é útil minimizar a comutação de contexto entre threads, o `InnoDB` pode usar diversas técnicas para limitar o número de threads do sistema operacional em execução concorrente (e, portanto, o número de solicitações processadas a qualquer momento). Quando o `InnoDB` recebe uma nova solicitação de uma sessão de usuário, se o número de threads em execução concorrente estiver em um limite predefinido, a nova solicitação dorme por um curto período antes de tentar novamente. Threads que estão esperando por Locks não são contados no número de threads em execução concorrente.

Você pode limitar o número de threads concorrentes definindo o parâmetro de configuração `innodb_thread_concurrency`. Assim que o número de threads em execução atinge esse limite, threads adicionais dormem por um número de microssegundos, definido pelo parâmetro de configuração `innodb_thread_sleep_delay`, antes de serem colocados na fila.

Anteriormente, era necessário experimentação para encontrar o valor ideal para `innodb_thread_sleep_delay`, e o valor ideal poderia mudar dependendo da workload. No MySQL 5.6.3 e superior, você pode definir a opção de configuração `innodb_adaptive_max_sleep_delay` para o valor mais alto que você permitiria para `innodb_thread_sleep_delay`, e o `InnoDB` ajusta automaticamente `innodb_thread_sleep_delay` para cima ou para baixo, dependendo da atividade atual de escalonamento de threads. Esse ajuste dinâmico ajuda o mecanismo de escalonamento de threads a funcionar sem problemas em momentos em que o sistema está com pouca carga e quando está operando próximo à capacidade máxima.

O valor padrão para `innodb_thread_concurrency` e o limite padrão implícito no número de threads concorrentes foram alterados em várias versões do MySQL e do `InnoDB`. O valor padrão de `innodb_thread_concurrency` é `0`, de modo que, por padrão, não há limite para o número de threads em execução concorrente.

O `InnoDB` faz com que os threads durmam apenas quando o número de threads concorrentes é limitado. Quando não há limite no número de threads, todos competem igualmente para serem escalonados. Ou seja, se `innodb_thread_concurrency` for `0`, o valor de `innodb_thread_sleep_delay` é ignorado.

Quando há um limite no número de threads (quando `innodb_thread_concurrency` é > 0), o `InnoDB` reduz a sobrecarga da comutação de contexto (context switching overhead) permitindo que múltiplas solicitações feitas durante a execução de uma *única instrução SQL* entrem no `InnoDB` sem observar o limite definido por `innodb_thread_concurrency`. Como uma instrução SQL (como um JOIN) pode compreender múltiplas operações de linha dentro do `InnoDB`, o `InnoDB` atribui um número especificado de “tickets” que permitem que um thread seja escalonado repetidamente com sobrecarga mínima.

Quando uma nova instrução SQL começa, um thread não tem tickets e deve observar `innodb_thread_concurrency`. Assim que o thread tem o direito de entrar no `InnoDB`, é atribuído a ele um número de tickets que pode usar para entrar subsequentemente no `InnoDB` para realizar operações de linha. Se os tickets acabarem, o thread é despejado (evicted), e `innodb_thread_concurrency` é observado novamente, o que pode colocar o thread de volta na fila first-in/first-out de threads em espera. Quando o thread tiver novamente o direito de entrar no `InnoDB`, os tickets são atribuídos novamente. O número de tickets atribuídos é especificado pela opção global `innodb_concurrency_tickets`, que é 5000 por padrão. Um thread que está esperando por um Lock recebe um ticket assim que o Lock se torna disponível.

Os valores corretos dessas variáveis dependem do seu ambiente e workload. Experimente uma variedade de valores diferentes para determinar qual valor funciona para suas aplicações. Antes de limitar o número de threads em execução concorrente, revise as opções de configuração que podem melhorar a performance do `InnoDB` em computadores multi-core e multi-processador, como `innodb_adaptive_hash_index`.

Para informações gerais sobre performance relacionadas ao manuseio de threads no MySQL, consulte a Seção 5.1.11.1, “Connection Interfaces”.