#### 14.9.1.4 Monitoramento da Compressão de Tabelas InnoDB em Tempo de Execução

O desempenho geral da aplicação, a utilização de CPU e I/O e o tamanho dos arquivos em disco são bons indicadores de quão eficaz a compressão é para sua aplicação. Esta seção se baseia nas dicas de ajuste de desempenho da Seção 14.9.1.3, “Ajustando a Compressão para Tabelas InnoDB”, e mostra como encontrar problemas que podem não aparecer durante os testes iniciais.

Para aprofundar as considerações de desempenho para tabelas compactadas, você pode monitorar o desempenho da compressão em tempo de execução usando as tabelas do Information Schema descritas no Exemplo 14.1, “Usando as Tabelas Information Schema de Compressão”. Essas tabelas refletem o uso interno de memória e as taxas de compressão usadas no geral.

A tabela `INNODB_CMP` reporta informações sobre a atividade de compressão para cada tamanho de página compactada (`KEY_BLOCK_SIZE`) em uso. A informação nestas tabelas é a nível de sistema (system-wide): ela resume as estatísticas de compressão em todas as tabelas compactadas no seu Database. Você pode usar esses dados para ajudar a decidir se deve ou não compactar uma tabela, examinando estas tabelas quando nenhuma outra tabela compactada estiver sendo acessada. Ela envolve um overhead relativamente baixo no server, de modo que você pode consultá-la periodicamente em um server de produção para verificar a eficiência geral do recurso de compressão.

A tabela `INNODB_CMP_PER_INDEX` reporta informações sobre a atividade de compressão para tabelas e Indexes individuais. Esta informação é mais direcionada e mais útil para avaliar a eficiência da compressão e diagnosticar problemas de desempenho uma tabela ou Index por vez. (Como cada tabela `InnoDB` é representada como um Index clusterizado, o MySQL não faz uma grande distinção entre tabelas e Indexes neste contexto.) A tabela `INNODB_CMP_PER_INDEX` envolve um overhead substancial, o que a torna mais adequada para servers de desenvolvimento, onde você pode comparar os efeitos de diferentes workloads, dados e configurações de compressão isoladamente. Para evitar a imposição acidental desse overhead de monitoramento, você deve habilitar a opção de configuração `innodb_cmp_per_index_enabled` antes de poder consultar a tabela `INNODB_CMP_PER_INDEX`.

As principais estatísticas a considerar são o número e a quantidade de tempo gasto na execução de operações de compressão e descompressão (uncompression). Uma vez que o MySQL divide nós B-tree quando eles estão muito cheios para conter os dados compactados após uma modificação, compare o número de operações de compressão “bem-sucedidas” com o número total dessas operações. Com base nas informações nas tabelas `INNODB_CMP` e `INNODB_CMP_PER_INDEX`, e no desempenho geral da aplicação e na utilização de recursos de hardware, você pode fazer alterações na sua configuração de hardware, ajustar o tamanho do Buffer Pool, escolher um tamanho de página diferente ou selecionar um conjunto diferente de tabelas para compactar.

Se a quantidade de tempo de CPU necessária para compactar e descompactar for alta, a mudança para CPUs mais rápidas ou multi-core pode ajudar a melhorar o desempenho com os mesmos dados, workload da aplicação e conjunto de tabelas compactadas. Aumentar o tamanho do Buffer Pool também pode ajudar no desempenho, permitindo que mais páginas descompactadas permaneçam na memória, reduzindo a necessidade de descompactar páginas que existem na memória apenas na forma compactada.

Um grande número total de operações de compressão (em comparação com o número de operações `INSERT`, `UPDATE` e `DELETE` na sua aplicação e o tamanho do Database) pode indicar que algumas de suas tabelas compactadas estão sendo atualizadas de forma muito intensa para uma compressão eficaz. Se for o caso, escolha um tamanho de página maior ou seja mais seletivo sobre quais tabelas você compacta.

Se o número de operações de compressão “bem-sucedidas” (`COMPRESS_OPS_OK`) for uma alta porcentagem do número total de operações de compressão (`COMPRESS_OPS`), é provável que o sistema esteja com bom desempenho. Se a proporção for baixa, o MySQL estará reorganizando, recompactando e dividindo nós B-tree com mais frequência do que o desejável. Neste caso, evite compactar algumas tabelas ou aumente o `KEY_BLOCK_SIZE` para algumas das tabelas compactadas. Você pode desativar a compressão para tabelas que fazem com que o número de “falhas de compressão” na sua aplicação seja superior a 1% ou 2% do total. (Tal proporção de falhas pode ser aceitável durante uma operação temporária, como um data load).