#### 17.1.3.1 Adesão ao Grupo

Em MySQL Group Replication, um conjunto de servidores forma um grupo de replicação. Um grupo possui um nome, que assume a forma de um UUID. O grupo é dinâmico, e os servidores podem sair (seja voluntária ou involuntariamente) e se juntar a ele a qualquer momento. O grupo se ajusta automaticamente sempre que servidores entram ou saem.

Se um servidor se junta ao grupo, ele automaticamente se atualiza, buscando o estado ausente em um servidor existente. Se um servidor sai do grupo, por exemplo, se foi desativado para manutenção, os servidores restantes percebem que ele saiu e reconfiguram o grupo automaticamente.

Group Replication possui um serviço de adesão ao grupo que define quais servidores estão online e participando do grupo. A lista de servidores online é chamada de *view*. Cada servidor no grupo tem uma *view* consistente de quais servidores são os membros que estão participando ativamente do grupo em um dado momento.

Os membros do grupo devem concordar não apenas nos *commits* de transação, mas também em qual é a *view* atual. Se os membros existentes concordam que um novo servidor deve se tornar parte do grupo, o grupo é reconfigurado para integrar esse servidor, o que dispara uma alteração de *view*. Se um servidor sai do grupo, voluntariamente ou não, o grupo reorganiza dinamicamente sua configuração e uma alteração de *view* é disparada.

No caso de um membro sair do grupo voluntariamente, ele primeiro inicia uma reconfiguração dinâmica do grupo, durante a qual todos os membros devem concordar com uma nova *view* sem o servidor que está saindo. No entanto, se um membro sai do grupo involuntariamente, por exemplo, porque parou inesperadamente ou a conexão de rede caiu, ele não pode iniciar a reconfiguração. Nesta situação, o mecanismo de detecção de falhas do Group Replication reconhece, após um curto período, que o membro saiu, e é proposta uma reconfiguração do grupo sem o membro que falhou. Assim como ocorre com um membro que sai voluntariamente, a reconfiguração exige o acordo da maioria dos servidores no grupo. Contudo, se o grupo não conseguir chegar a um acordo, por exemplo, porque foi particionado de forma que não há maioria de servidores online, o sistema não consegue alterar dinamicamente a configuração e bloqueia para evitar uma situação de *split-brain*. Essa situação requer intervenção de um administrador.

É possível que um membro fique offline por um curto período de tempo e, em seguida, tente se juntar novamente ao grupo antes que o mecanismo de detecção de falhas tenha detectado sua falha, e antes que o grupo tenha sido reconfigurado para remover o membro. Nesta situação, o membro que está se juntando novamente esquece seu estado anterior, mas se outros membros enviarem mensagens destinadas ao seu estado pré-falha, isso pode causar problemas, incluindo possível inconsistência de dados. Se um membro nesta situação participar do protocolo de consenso do XCom, isso poderia potencialmente fazer com que o XCom entregasse valores diferentes para a mesma rodada de consenso, tomando uma decisão diferente antes e depois da falha.

Para evitar essa possibilidade, a partir do MySQL 5.7.22, os servidores recebem um identificador exclusivo quando se juntam a um grupo. Isso permite que o Group Replication esteja ciente da situação em que uma nova encarnação do mesmo servidor (com o mesmo endereço, mas um novo identificador) está tentando se juntar ao grupo enquanto sua antiga encarnação ainda está listada como membro. A nova encarnação é impedida de se juntar ao grupo até que a encarnação antiga possa ser removida por uma reconfiguração. Se o Group Replication for parado e reiniciado no servidor, o membro se torna uma nova encarnação e não pode se juntar novamente até que o período de suspeita expire.