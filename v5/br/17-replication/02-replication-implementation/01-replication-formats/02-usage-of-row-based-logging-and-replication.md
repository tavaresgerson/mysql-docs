#### 16.2.1.2 Uso do Registro e Replicação Baseado em Linhas

O MySQL utiliza o registro baseado em instruções (SBL), o registro baseado em linhas (RBL) ou o registro de formato misto. O tipo de log binário utilizado afeta o tamanho e a eficiência do registro. Portanto, a escolha entre a replicação baseada em linhas (RBR) ou a replicação baseada em instruções (SBR) depende da sua aplicação e do ambiente. Esta seção descreve os problemas conhecidos ao usar um log de formato baseado em linhas e descreve algumas melhores práticas para usá-lo na replicação.

Para obter informações adicionais, consulte Seção 16.2.1, “Formatos de Replicação” e Seção 16.2.1.1, “Vantagens e Desvantagens da Replicação Baseada em Declarações e Replicação Baseada em Linhas”.

Para obter informações sobre problemas específicos da Replicação em NDB Cluster (que depende da replicação baseada em linhas), consulte Seção 21.7.3, “Problemas Conhecidos na Replicação em NDB Cluster”.

- **Registro em linhas de tabelas temporárias.** Como observado em Seção 16.4.1.29, “Replicação e Tabelas Temporárias”, as tabelas temporárias não são replicadas ao usar o formato em linhas. Ao usar o registro em formato misto, as instruções “seguras” que envolvem tabelas temporárias são registradas usando o formato em instruções. Para mais informações, consulte Seção 16.2.1.1, “Vantagens e Desvantagens da Replicação em Instruções e em Linhas”.

  As tabelas temporárias não são replicadas ao usar o formato baseado em linhas, porque não há necessidade. Além disso, como as tabelas temporárias podem ser lidas apenas pelo thread que as criou, raramente, se é que alguma vez, há algum benefício obtido ao replicadas, mesmo quando se usa o formato baseado em instruções.

  Você pode alternar do formato de registro binário baseado em declarações para o formato baseado em linhas no tempo real, mesmo quando tabelas temporárias já foram criadas. A partir do MySQL 5.7.25, o servidor MySQL registra o modo de registro que estava em vigor quando cada tabela temporária foi criada. Quando uma sessão de cliente específica termina, o servidor registra uma declaração `DROP TEMPORARY TABLE IF EXISTS` para cada tabela temporária que ainda existe e foi criada quando o registro binário baseado em declarações estava em uso. Se o registro binário baseado em linhas ou misto estava em uso quando a tabela foi criada, a declaração `DROP TEMPORARY TABLE IF EXISTS` não é registrada. Em versões anteriores, a declaração `DROP TEMPORARY TABLE IF EXISTS` era registrada, independentemente do modo de registro que estava em vigor.

  As instruções DML não transacionais que envolvem tabelas temporárias são permitidas ao usar [`binlog_format=ROW`](https://pt.docs.oracle.com/topics/replication/options/binary-log/binlogformat.htm#sysvar_binlogformat), desde que quaisquer tabelas não transacionais afetadas pelas instruções sejam tabelas temporárias (Bug #14272672).

- **RBL e sincronização de tabelas não transacionais.** Quando muitas linhas são afetadas, o conjunto de alterações é dividido em vários eventos; quando a instrução é confirmada, todos esses eventos são escritos no log binário. Ao executar na replica, uma trava de tabela é aplicada em todas as tabelas envolvidas, e então as linhas são aplicadas em modo lote. Dependendo do motor usado para a cópia da tabela da replica, isso pode ou não ser eficaz.

- **Latência e tamanho do log binário.** O RBL escreve as alterações para cada linha no log binário, e, portanto, seu tamanho pode aumentar rapidamente. Isso pode aumentar significativamente o tempo necessário para fazer alterações na replica que correspondem às do banco de dados de origem. Você deve estar ciente do potencial desse atraso em seus aplicativos.

- **Leitura do log binário.** **mysqlbinlog** exibe eventos baseados em linhas no log binário usando a instrução `BINLOG` (consulte Seção 13.7.6.1, “Instrução BINLOG”). Esta instrução exibe um evento como uma string codificada em base 64, cujo significado não é evidente. Quando invocada com as opções `--base64-output=DECODE-ROWS` e `--verbose`, **mysqlbinlog** formata o conteúdo do log binário para ser legível para humanos. Quando eventos do log binário foram escritos em formato baseado em linhas e você deseja ler ou recuperar de uma falha de replicação ou banco de dados, você pode usar este comando para ler o conteúdo do log binário. Para mais informações, consulte Seção 4.6.7.2, “Exibição de Evento de Linha mysqlbinlog”.

- **Erros de execução do log binário e modo de execução da replica.** O uso de `slave_exec_mode=IDEMPOTENT` geralmente é útil apenas com a replicação do MySQL NDB Cluster, para a qual `IDEMPOTENT` é o valor padrão. (Veja Seção 21.7.10, “Replicação do NDB Cluster: Replicação Bidirecional e Circular”). Quando `slave_exec_mode` é `IDEMPOTENT`, uma falha na aplicação de alterações do RBL porque a linha original não pode ser encontrada não desencadeia um erro ou faz com que a replicação falhe. Isso significa que é possível que as atualizações não sejam aplicadas na replica, de modo que a fonte e a replica não estejam mais sincronizadas. Problemas de latência e uso de tabelas não transacionais com o RBR quando `slave_exec_mode` é `IDEMPOTENT` podem fazer com que a fonte e a replica se desviem ainda mais. Para mais informações sobre `slave_exec_mode`, consulte Seção 5.1.7, “Variáveis de Sistema do Servidor”.

  Para outros cenários, definir `slave_exec_mode` para `STRICT` é normalmente suficiente; esse é o valor padrão para os motores de armazenamento que não são o `NDB`.

- **Filtragem com base no ID do servidor não é suportada.** Você pode filtrar com base no ID do servidor usando a opção `IGNORE_SERVER_IDS` para a declaração `ALTER MASTER TO`. Esta opção funciona com formatos de registro baseados em declarações e baseados em linhas. Outro método para filtrar mudanças em algumas réplicas é usar uma cláusula `WHERE` que inclui a cláusula `@@server_id <> id_value` com as declarações `UPDATE` e `DELETE`. Por exemplo, `WHERE @@server_id <> 1`. No entanto, isso não funciona corretamente com o registro baseado em linhas. Para usar a variável de sistema `@@server_id` para filtragem de declarações, use o registro baseado em declarações.

- **Tabelas RBL, não transacionais e réplicas paralisadas.** Ao usar o registro baseado em linhas, se o servidor de réplica for parado enquanto um fio de replicação está atualizando uma tabela não transacional, o banco de dados da réplica pode chegar a um estado inconsistente. Por essa razão, recomenda-se que você use um motor de armazenamento transacional, como `InnoDB`, para todas as tabelas replicadas usando o formato baseado em linhas. O uso de `STOP SLAVE` ou `STOP SLAVE SQL_THREAD` antes de desligar o servidor de réplica ajuda a evitar problemas e é sempre recomendado, independentemente do formato de registro ou do motor de armazenamento que você usar.
