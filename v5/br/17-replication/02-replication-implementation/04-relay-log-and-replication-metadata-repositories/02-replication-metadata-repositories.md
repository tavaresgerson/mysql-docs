#### 16.2.4.2 Repositórios de Metadados de Replication

Um servidor replica cria dois repositórios de metadados de Replication: o repositório de metadados de conexão e o repositório de metadados do Applier. Os repositórios de metadados de Replication sobrevivem ao *shutdown* (desligamento) de um servidor replica. Se o *binary log file position based replication* estiver em uso, quando a replica reiniciar, ela lê os dois repositórios para determinar o quão longe ela havia progredido na leitura do *binary log* da *source* (origem) e no processamento do seu próprio *relay log*. Se o *GTID-based replication* estiver em uso, a replica não utiliza os repositórios de metadados de Replication para esse propósito, mas ainda precisa deles para os outros metadados que contêm.

* O *connection metadata repository* da replica contém informações que o *replication I/O thread* precisa para se conectar ao servidor *source* de Replication e recuperar transações do *binary log* da *source*. Os metadados neste repositório incluem a configuração da conexão, os detalhes da conta de usuário de Replication, as configurações de *SSL* para a conexão e o nome e a posição do arquivo onde o *replication I/O thread* está lendo atualmente do *binary log* da *source*.

* O *applier metadata repository* da replica contém informações que o *replication SQL thread* precisa para ler e aplicar transações do *relay log* da replica. Os metadados neste repositório incluem o nome e a posição do arquivo até onde o *replication SQL thread* executou as transações no *relay log*, e a posição equivalente no *binary log* da *source*. Ele também inclui metadados para o processo de aplicação de transações, como o número de *worker threads*.

Por padrão, os repositórios de metadados de Replication são criados como arquivos no diretório de dados chamados `master.info` e `relay-log.info`, ou com nomes e locais alternativos especificados pela opção [`--master-info-file`](replication-options-replica.html#option_mysqld_master-info-file) e pela variável de sistema [`relay_log_info_file`](replication-options-replica.html#sysvar_relay_log_info_file). Para criar os repositórios de metadados de Replication como *tables*, especifique [`master_info_repository=TABLE`](replication-options-replica.html#sysvar_master_info_repository) e [`relay_log_info_repository=TABLE`](replication-options-replica.html#sysvar_relay_log_info_repository) na inicialização do servidor. Nesse caso, o *connection metadata repository* da replica é escrito na *table* `slave_master_info` no *schema* de sistema `mysql`, e o *applier metadata repository* da replica é escrito na *table* `slave_relay_log_info` no *schema* de sistema `mysql`. Uma mensagem de aviso é emitida se o [**mysqld**](mysqld.html "4.3.1 mysqld — The MySQL Server") for incapaz de inicializar as *tables* para os repositórios de metadados de Replication, mas a replica é autorizada a continuar a inicialização. Esta situação é mais provável de ocorrer ao fazer *upgrade* de uma versão do MySQL que não suporta o uso de *tables* para os repositórios para uma versão na qual eles são suportados.

Importante

1. Não tente atualizar (*update*) ou inserir (*insert*) linhas nas *tables* `mysql.slave_master_info` ou `mysql.slave_relay_log_info` manualmente. Fazer isso pode causar comportamento indefinido e não é suportado. A execução de qualquer instrução que exija um *write lock* em uma ou em ambas as *tables* `slave_master_info` e `slave_relay_log_info` é proibida enquanto a Replication estiver em andamento (embora instruções que realizam apenas leituras sejam permitidas a qualquer momento).

2. O acesso ao arquivo ou *table* do *connection metadata repository* da replica deve ser restrito ao administrador do *Database*, porque ele contém o nome de usuário e a senha da conta de Replication para conexão com a *source*. Use um modo de acesso restrito para proteger *backups* do *Database* que incluam este repositório.

[`RESET SLAVE`](reset-slave.html "13.4.2.3 RESET SLAVE Statement") limpa os dados nos repositórios de metadados de Replication, com exceção dos parâmetros de conexão de Replication (dependendo da versão do MySQL Server e do tipo de repositório). Para detalhes, consulte a descrição de [`RESET SLAVE`](reset-slave.html "13.4.2.3 RESET SLAVE Statement").

Se você definir [`master_info_repository`](replication-options-replica.html#sysvar_master_info_repository) e [`relay_log_info_repository`](replication-options-replica.html#sysvar_relay_log_info_repository) como `TABLE`, as *tables* `mysql.slave_master_info` e `mysql.slave_relay_log_info` são criadas usando o *transactional storage engine* [`InnoDB`](innodb-storage-engine.html "Chapter 14 The InnoDB Storage Engine"). As atualizações para a *table* do *applier metadata repository* da replica são confirmadas (*committed*) juntamente com as transações, o que significa que a informação de progresso da replica registrada nesse repositório é sempre consistente com o que foi aplicado ao *Database*, mesmo no caso de uma interrupção inesperada do servidor. A opção [`--relay-log-recovery`](replication-options-replica.html#sysvar_relay_log_recovery) deve estar habilitada na replica para garantir a resiliência. Para mais detalhes, consulte [Section 16.3.2, “Lidando com uma Parada Inesperada de uma Replica”](replication-solutions-unexpected-replica-halt.html "16.3.2 Handling an Unexpected Halt of a Replica").

Ao fazer *backup* dos dados da replica ou transferir um *snapshot* de seus dados para criar uma nova replica, certifique-se de incluir as *tables* `mysql.slave_master_info` e `mysql.slave_relay_log_info` contendo os repositórios de metadados de Replication, ou os arquivos equivalentes (`master.info` e `relay-log.info` no diretório de dados, a menos que você tenha especificado nomes e locais alternativos). Quando o *binary log file position based replication* está em uso, os repositórios de metadados de Replication são necessários para retomar a Replication após reiniciar a replica restaurada ou copiada. Se você não tiver os arquivos do *relay log*, mas ainda tiver o *applier metadata repository* da replica, você pode verificá-lo para determinar o quão longe o *replication SQL thread* executou no *binary log* da *source*. Em seguida, você pode usar uma instrução [`CHANGE MASTER TO`](change-master-to.html "13.4.2.1 CHANGE MASTER TO Statement") com as opções `MASTER_LOG_FILE` e `MASTER_LOG_POS` para instruir a replica a reler os *binary logs* da *source* a partir desse ponto (desde que os *binary logs* necessários ainda existam na *source*).

Um repositório adicional, o *applier worker metadata repository*, é criado principalmente para uso interno e contém informações de *status* sobre *worker threads* em uma replica *multithreaded*. O *applier worker metadata repository* inclui os nomes e posições do arquivo *relay log* e do arquivo *binary log* da *source* para cada *worker thread*. Se o *applier metadata repository* da replica for criado como uma *table*, o que é o padrão, o *applier worker metadata repository* é escrito na *table* `mysql.slave_worker_info`. Se o *applier metadata repository* for escrito em um arquivo, o *applier worker metadata repository* é escrito no arquivo `worker-relay-log.info`. Para uso externo, as informações de *status* para *worker threads* são apresentadas na *table* [`replication_applier_status_by_worker`](performance-schema-replication-applier-status-by-worker-table.html "25.12.11.6 The replication_applier_status_by_worker Table") do Performance Schema.

Os repositórios de metadados de Replication continham originalmente informações semelhantes às mostradas na saída da instrução [`SHOW SLAVE STATUS`](show-slave-status.html "13.7.5.34 SHOW SLAVE STATUS Statement"), que é discutida na [Section 13.4.2, “SQL Statements for Controlling Replica Servers”](replication-statements-replica.html "13.4.2 SQL Statements for Controlling Replica Servers"). Desde então, informações adicionais foram incluídas nos repositórios de metadados de Replication que não são exibidas pela instrução [`SHOW SLAVE STATUS`](show-slave-status.html "13.7.5.34 SHOW SLAVE STATUS Statement").

Para o *connection metadata repository*, a tabela a seguir mostra a correspondência entre as colunas na *table* `mysql.slave_master_info`, as colunas exibidas por [`SHOW SLAVE STATUS`](show-slave-status.html "13.7.5.34 SHOW SLAVE STATUS Statement") e as linhas no arquivo `master.info`.

<table summary="A correspondência entre as linhas no arquivo master.info, as colunas na table mysql.slave_master_info e as colunas exibidas por SHOW SLAVE STATUS."><col style="width: 16%"/><col style="width: 31%"/><col style="width: 40%"/><col style="width: 18%"/><thead><tr> <th>Linha do Arquivo <code>master.info</code></th> <th>Coluna da Tabela <code>slave_master_info</code></th> <th>Coluna do <code>SHOW SLAVE STATUS</code></th> <th>Descrição</th> </tr></thead><tbody><tr> <th>1</th> <td><code>Number_of_lines</code></td> <td>[None]</td> <td>Número de linhas no arquivo, ou colunas na *table*</td> </tr><tr> <th>2</th> <td><code>Master_log_name</code></td> <td><code>Master_Log_File</code></td> <td>O nome do *binary log* que está sendo lido atualmente da *source*</td> </tr><tr> <th>3</th> <td><code>Master_log_pos</code></td> <td><code>Read_Master_Log_Pos</code></td> <td>A posição atual dentro do *binary log* que foi lida da *source*</td> </tr><tr> <th>4</th> <td><code>Host</code></td> <td><code>Master_Host</code></td> <td>O nome de *host* do servidor *source*</td> </tr><tr> <th>5</th> <td><code>User_name</code></td> <td><code>Master_User</code></td> <td>O nome de usuário de Replication usado para conectar à *source*</td> </tr><tr> <th>6</th> <td><code>User_password</code></td> <td>Password (não exibido por <code>SHOW SLAVE STATUS</code>)</td> <td>A senha usada para conectar à *source*</td> </tr><tr> <th>7</th> <td><code>Port</code></td> <td><code>Master_Port</code></td> <td>A *port* de rede usada para conectar à *source*</td> </tr><tr> <th>8</th> <td><code>Connect_retry</code></td> <td><code>Connect_Retry</code></td> <td>O período (em segundos) que a replica espera antes de tentar reconectar à *source*</td> </tr><tr> <th>9</th> <td><code>Enabled_ssl</code></td> <td><code>Master_SSL_Allowed</code></td> <td>Indica se o servidor suporta conexões *SSL*</td> </tr><tr> <th>10</th> <td><code>Ssl_ca</code></td> <td><code>Master_SSL_CA_File</code></td> <td>O arquivo usado para o certificado da Autoridade Certificadora (*CA*)</td> </tr><tr> <th>11</th> <td><code>Ssl_capath</code></td> <td><code>Master_SSL_CA_Path</code></td> <td>O *path* para os certificados da Autoridade Certificadora (*CA*)</td> </tr><tr> <th>12</th> <td><code>Ssl_cert</code></td> <td><code>Master_SSL_Cert</code></td> <td>O nome do arquivo de certificado *SSL*</td> </tr><tr> <th>13</th> <td><code>Ssl_cipher</code></td> <td><code>Master_SSL_Cipher</code></td> <td>A lista de *ciphers* possíveis usados no *handshake* para a conexão *SSL*</td> </tr><tr> <th>14</th> <td><code>Ssl_key</code></td> <td><code>Master_SSL_Key</code></td> <td>O nome do arquivo *key* *SSL*</td> </tr><tr> <th>15</th> <td><code>Ssl_verify_server_cert</code></td> <td><code>Master_SSL_Verify_Server_Cert</code></td> <td>Se o certificado do servidor deve ser verificado</td> </tr><tr> <th>16</th> <td><code>Heartbeat</code></td> <td>[None]</td> <td>Intervalo entre *replication heartbeats*, em segundos</td> </tr><tr> <th>17</th> <td><code>Bind</code></td> <td><code>Master_Bind</code></td> <td>Qual das interfaces de rede da replica deve ser usada para conectar à *source*</td> </tr><tr> <th>18</th> <td><code>Ignored_server_ids</code></td> <td><code>Replicate_Ignore_Server_Ids</code></td> <td>A lista de *server IDs* a serem ignorados. Note que para <code>Ignored_server_ids</code>, a lista de *server IDs* é precedida pelo número total de *server IDs* a ignorar.</td> </tr><tr> <th>19</th> <td><code>Uuid</code></td> <td><code>Master_UUID</code></td> <td>O *ID* único da *source*</td> </tr><tr> <th>20</th> <td><code>Retry_count</code></td> <td><code>Master_Retry_Count</code></td> <td>Número máximo de tentativas de reconexão permitidas</td> </tr><tr> <th>21</th> <td><code>Ssl_crl</code></td> <td>[None]</td> <td>*Path* para um arquivo de lista de revogação de certificado *SSL*</td> </tr><tr> <th>22</th> <td><code>Ssl_crlpath</code></td> <td>[None]</td> <td>*Path* para um diretório contendo arquivos de lista de revogação de certificado *SSL*</td> </tr><tr> <th>23</th> <td><code>Enabled_auto_position</code></td> <td><code>Auto_position</code></td> <td>Se o autoposicionamento está em uso ou não</td> </tr><tr> <th>24</th> <td><code>Channel_name</code></td> <td><code>Channel_name</code></td> <td>O nome do *replication channel*</td> </tr><tr> <th>25</th> <td><code>Tls_version</code></td> <td><code>Master_TLS_Version</code></td> <td>Versão *TLS* na *source*</td> </tr> </tbody></table>

Para o *applier metadata repository*, a tabela a seguir mostra a correspondência entre as colunas na *table* `mysql.slave_relay_log_info`, as colunas exibidas por [`SHOW SLAVE STATUS`](show-slave-status.html "13.7.5.34 SHOW SLAVE STATUS Statement") e as linhas no arquivo `relay-log.info`.

<table summary="A correspondência entre as linhas no arquivo relay-log.info, as colunas na table mysql.slave_relay_log_info e as colunas exibidas por SHOW SLAVE STATUS."><col style="width: 15%"/><col style="width: 30%"/><col style="width: 40%"/><col style="width: 20%"/><thead><tr> <th>Linha em <code>relay-log.info</code></th> <th>Coluna da Tabela <code>slave_relay_log_info</code></th> <th>Coluna do <code>SHOW SLAVE STATUS</code></th> <th>Descrição</th> </tr></thead><tbody><tr> <th>1</th> <td><code>Number_of_lines</code></td> <td>[None]</td> <td>Número de linhas no arquivo ou colunas na *table*</td> </tr><tr> <th>2</th> <td><code>Relay_log_name</code></td> <td><code>Relay_Log_File</code></td> <td>O nome do arquivo *relay log* atual</td> </tr><tr> <th>3</th> <td><code>Relay_log_pos</code></td> <td><code>Relay_Log_Pos</code></td> <td>A posição atual dentro do arquivo *relay log*; eventos até esta posição foram executados no *Database* da replica</td> </tr><tr> <th>4</th> <td><code>Master_log_name</code></td> <td><code>Relay_Master_Log_File</code></td> <td>O nome do arquivo *binary log* da *source* a partir do qual os eventos no arquivo *relay log* foram lidos</td> </tr><tr> <th>5</th> <td><code>Master_log_pos</code></td> <td><code>Exec_Master_Log_Pos</code></td> <td>A posição equivalente dentro do arquivo *binary log* da *source* dos eventos que já foram executados</td> </tr><tr> <th>6</th> <td><code>Sql_delay</code></td> <td><code>SQL_Delay</code></td> <td>O número de segundos que a replica deve atrasar em relação à *source* (*lag*)</td> </tr><tr> <th>7</th> <td><code>Number_of_workers</code></td> <td>[None]</td> <td>O número de *worker threads* na replica para executar eventos de Replication (transações) em paralelo</td> </tr><tr> <th>8</th> <td><code>Id</code></td> <td>[None]</td> <td>ID usado para fins internos; atualmente é sempre 1</td> </tr><tr> <th>9</th> <td><code>Channel_name</code></td> <td>Channel_name</td> <td>O nome do *replication channel*</td> </tr></tbody></table>

Em versões do MySQL anteriores à MySQL 5.6, o arquivo `relay-log.info` não inclui uma contagem de linhas ou um valor de *delay* (e a *table* `slave_relay_log_info` não está disponível).

<table summary="A correspondência entre as linhas no arquivo relay-log.info e os itens que aparecem na coluna Status."><col style="width: 15%"/><col style="width: 35%"/><col style="width: 50%"/><thead><tr> <th>Linha</th> <th>Coluna Status</th> <th>Descrição</th> </tr></thead><tbody><tr> <th>1</th> <td><code>Relay_Log_File</code></td> <td>O nome do arquivo *relay log* atual</td> </tr><tr> <th>2</th> <td><code>Relay_Log_Pos</code></td> <td>A posição atual dentro do arquivo *relay log*; eventos até esta posição foram executados no *Database* da replica</td> </tr><tr> <th>3</th> <td><code>Relay_Master_Log_File</code></td> <td>O nome do arquivo *binary log* da *source* a partir do qual os eventos no arquivo *relay log* foram lidos</td> </tr><tr> <th>4</th> <td><code>Exec_Master_Log_Pos</code></td> <td>A posição equivalente dentro do arquivo *binary log* da *source* dos eventos que já foram executados</td> </tr></tbody></table>

Note

Se você fizer *downgrade* de um servidor replica para uma versão anterior à MySQL 5.6, o servidor mais antigo não lerá o arquivo `relay-log.info` corretamente. Para resolver isso, modifique o arquivo em um editor de texto excluindo a linha inicial que contém o número de linhas.

O conteúdo do arquivo `relay-log.info` e os estados mostrados pela instrução [`SHOW SLAVE STATUS`](show-slave-status.html "13.7.5.34 SHOW SLAVE STATUS Statement") podem não coincidir se o arquivo `relay-log.info` não tiver sido *flushed* para o disco. Idealmente, você só deve visualizar `relay-log.info` em uma replica que esteja *offline* (ou seja, `mysqld` não está em execução). Para um sistema em execução, você pode usar [`SHOW SLAVE STATUS`](show-slave-status.html "13.7.5.34 SHOW SLAVE STATUS Statement"), ou consultar as *tables* `mysql.slave_master_info` e `mysql.slave_relay_log_info` se estiver escrevendo os repositórios de metadados de Replication em *tables*.