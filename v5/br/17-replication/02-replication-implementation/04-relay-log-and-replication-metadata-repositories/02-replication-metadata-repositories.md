#### 16.2.4.2 Repositórios de metadados de replicação

Um servidor de replicação cria dois repositórios de metadados de replicação: o repositório de metadados de conexão e o repositório de metadados do aplicável. Os repositórios de metadados de replicação sobrevivem ao desligamento de um servidor de replicação. Se a replicação baseada na posição do arquivo de log binário estiver em uso, quando a replicação for reiniciada, ela lê os dois repositórios para determinar até onde havia avançado anteriormente na leitura do log binário da fonte e no processamento do seu próprio log de retransmissão. Se a replicação baseada no GTID estiver em uso, a replicação não usa os repositórios de metadados de replicação para esse propósito, mas precisa deles para os outros metadados que contêm.

- O *repositório de metadados de conexão* da réplica contém informações que a thread de E/S de replicação precisa para se conectar ao servidor de origem da replicação e recuperar transações do log binário da fonte. Os metadados neste repositório incluem a configuração de conexão, os detalhes da conta de usuário de replicação, as configurações SSL para a conexão e o nome do arquivo e a posição onde a thread de E/S de replicação está lendo atualmente do log binário da fonte.

- O repositório de metadados do *aplicador de réplicas* contém informações que o fio de SQL de replicação precisa ler e aplicar transações do log de retransmissão da réplica. Os metadados neste repositório incluem o nome do arquivo e a posição até a qual o fio de SQL de replicação executou as transações no log de retransmissão, e a posição equivalente no log binário da fonte. Também inclui metadados para o processo de aplicação de transações, como o número de threads de trabalhador.

Por padrão, os repositórios de metadados de replicação são criados como arquivos no diretório de dados com os nomes `master.info` e `relay-log.info`, ou com nomes e localizações alternativas especificados pela opção `--master-info-file` (replication-options-replica.html#option_mysqld_master-info-file) e pela variável de sistema `relay_log_info_file` (replication-options-replica.html#sysvar_relay_log_info_file). Para criar os repositórios de metadados de replicação como tabelas, especifique `master_info_repository=TABLE` (replication-options-replica.html#sysvar_master_info_repository) e `relay_log_info_repository=TABLE` (replication-options-replica.html#sysvar_relay_log_info_repository) no início do servidor. Nesse caso, o repositório de metadados de conexão da replica é escrito na tabela `slave_master_info` no esquema de sistema `mysql`, e o repositório de metadados de aplicador da replica é escrito na tabela `slave_relay_log_info` no esquema de sistema `mysql`. Uma mensagem de aviso é emitida se o [**mysqld**](mysqld.html) não conseguir inicializar as tabelas para os repositórios de metadados de replicação, mas a replica é permitida para continuar iniciando. Essa situação provavelmente ocorrerá quando você estiver atualizando de uma versão do MySQL que não suporta o uso de tabelas para os repositórios para uma versão em que elas são suportadas.

Importante

1. Não tente atualizar ou inserir linhas nas tabelas `mysql.slave_master_info` ou `mysql.slave_relay_log_info` manualmente. Isso pode causar comportamento indefinido e não é suportado. A execução de qualquer instrução que exija um bloqueio de escrita em uma ou ambas as tabelas `slave_master_info` e `slave_relay_log_info` é desaconselhada durante a replicação (embora instruções que realizam apenas leituras sejam permitidas a qualquer momento).

2. O acesso ao arquivo ou tabela do repositório de metadados de conexão da réplica deve ser restrito ao administrador do banco de dados, pois ele contém o nome e a senha da conta de usuário de replicação para se conectar à fonte. Use um modo de acesso restrito para proteger os backups do banco de dados que incluem esse repositório.

[`RESET SLAVE`](reset-slave.html) limpa os dados nos repositórios de metadados de replicação, com exceção dos parâmetros de conexão de replicação (dependendo da versão do MySQL Server e do tipo de repositório). Para obter detalhes, consulte a descrição de [`RESET SLAVE`](reset-slave.html).

Se você definir [`master_info_repository`](replication-options-replica.html#sysvar_master_info_repository) e [`relay_log_info_repository`](replication-options-replica.html#sysvar_relay_log_info_repository) como `TABLE`, as tabelas `mysql.slave_master_info` e `mysql.slave_relay_log_info` são criadas usando o mecanismo de armazenamento transacional `[InnoDB]` (innodb-storage-engine.html). As atualizações no repositório de metadados do aplicador da replica são confirmadas junto com as transações, o que significa que as informações de progresso da replica registradas nesse repositório estão sempre consistentes com o que foi aplicado ao banco de dados, mesmo em caso de uma parada inesperada do servidor. A opção `--relay-log-recovery` (replication-options-replica.html#sysvar_relay_log_recovery) deve ser habilitada na replica para garantir a resiliência. Para mais detalhes, consulte [Seção 16.3.2, “Tratamento de uma Parada Inesperada de uma Replica”](replication-solutions-unexpected-replica-halt.html).

Ao fazer o backup dos dados da replica ou transferir uma instantânea de seus dados para criar uma nova replica, certifique-se de incluir as tabelas `mysql.slave_master_info` e `mysql.slave_relay_log_info`, que contêm os repositórios de metadados de replicação, ou os arquivos equivalentes (`master.info` e `relay-log.info` no diretório de dados, a menos que você tenha especificado nomes e localizações alternativos). Quando a replicação baseada na posição do arquivo de log binário está em uso, os repositórios de metadados de replicação são necessários para retomar a replicação após o reinício da replica restaurada ou copiada. Se você não tiver os arquivos de log de retransmissão, mas ainda tiver o repositório de metadados do aplicador da replica, você pode verificá-lo para determinar até onde o thread SQL de replicação executou no log binário da fonte (desde que os logs binários necessários ainda existam na fonte). Em seguida, você pode usar uma declaração [`CHANGE MASTER TO`](change-master-to.html) com as opções `MASTER_LOG_FILE` e `MASTER_LOG_POS` para dizer à replica para reler os logs binários da fonte a partir desse ponto (desde que os logs binários necessários ainda existam na fonte).

Um repositório adicional, o repositório de metadados do trabalhador aplicador, é criado principalmente para uso interno e contém informações de status sobre os threads do trabalhador em uma replica multithread. O repositório de metadados do trabalhador aplicador inclui os nomes e posições do arquivo de log de retransmissão e do arquivo binário de origem para cada thread do trabalhador. Se o repositório de metadados do aplicador da replica for criado como uma tabela, o que é o padrão, o repositório de metadados do trabalhador aplicador é escrito na tabela `mysql.slave_worker_info`. Se o repositório de metadados do aplicador for escrito em um arquivo, o repositório de metadados do trabalhador aplicador é escrito no arquivo `worker-relay-log.info`. Para uso externo, as informações de status dos threads do trabalhador são apresentadas na tabela do Schema de Desempenho [`replication_applier_status_by_worker`](performance-schema-replication-applier-status-by-worker-table.html).

Os repositórios de metadados de replicação originalmente continham informações semelhantes às exibidas na saída da declaração [`SHOW SLAVE STATUS`](show-slave-status.html), que é discutida na [Seção 13.4.2, “Declarações SQL para Controle de Servidores de Replicação”](replication-statements-replica.html). Informações adicionais foram posteriormente adicionadas aos repositórios de metadados de replicação que não são exibidas pela declaração [`SHOW SLAVE STATUS`](show-slave-status.html).

Para o repositório de metadados de conexão, a tabela a seguir mostra a correspondência entre as colunas da tabela `mysql.slave_master_info`, as colunas exibidas pelo [`SHOW SLAVE STATUS`](show-slave-status.html) e as linhas no arquivo `master.info`.

<table summary="A correspondência entre as linhas no arquivo master.info, as colunas na tabela mysql.slave_master_info e as colunas exibidas pelo comando SHOW SLAVE STATUS."><col style="width: 16%"/><col style="width: 31%"/><col style="width: 40%"/><col style="width: 18%"/><thead><tr> <th>[[PH_HTML_CODE_<code>User_name</code>] Linha de arquivo</th> <th>[[PH_HTML_CODE_<code>User_name</code>] Coluna da tabela</th> <th>[[PH_HTML_CODE_<code>User_password</code>] Coluna</th> <th>Descrição</th> </tr></thead><tbody><tr> <th>1</th> <td>[[PH_HTML_CODE_<code>SHOW SLAVE STATUS</code>]</td> <td>[Nenhu<code>User_name</code></td> <td>Número de linhas no arquivo ou de colunas na tabela</td> </tr><tr> <th>2</th> <td>[[PH_HTML_CODE_<code>Port</code>]</td> <td>[[PH_HTML_CODE_<code>Master_Port</code>]</td> <td>O nome do log binário atualmente sendo lido da fonte</td> </tr><tr> <th>3</th> <td>[[PH_HTML_CODE_<code>Connect_retry</code>]</td> <td>[[PH_HTML_CODE_<code>Connect_Retry</code>]</td> <td>A posição atual dentro do log binário que foi lido da fonte</td> </tr><tr> <th>4</th> <td>[[PH_HTML_CODE_<code>Enabled_ssl</code>]</td> <td>[[PH_HTML_CODE_<code>Master_SSL_Allowed</code>]</td> <td>O nome do host do servidor de origem</td> </tr><tr> <th>5</th> <td>[[<code>User_name</code>]]</td> <td>[[<code>slave_master_info</code><code>User_name</code>]</td> <td>O nome de usuário de replicação usado para se conectar à fonte</td> </tr><tr> <th>6</th> <td>[[<code>User_password</code>]]</td> <td>Senha (não exibida por[[<code>SHOW SLAVE STATUS</code>]])</td> <td>A senha usada para se conectar à fonte</td> </tr><tr> <th>7</th> <td>[[<code>Port</code>]]</td> <td>[[<code>Master_Port</code>]]</td> <td>O porta de rede usado para se conectar à fonte</td> </tr><tr> <th>8</th> <td>[[<code>Connect_retry</code>]]</td> <td>[[<code>Connect_Retry</code>]]</td> <td>O período (em segundos) que a réplica espera antes de tentar se reconectar à fonte</td> </tr><tr> <th>9</th> <td>[[<code>Enabled_ssl</code>]]</td> <td>[[<code>Master_SSL_Allowed</code>]]</td> <td>Indica se o servidor suporta conexões SSL</td> </tr><tr> <th>10</th> <td>[[<code>SHOW SLAVE STATUS</code><code>User_name</code>]</td> <td>[[<code>SHOW SLAVE STATUS</code><code>User_name</code>]</td> <td>O arquivo usado para o certificado da Autoridade de Certificação (CA)</td> </tr><tr> <th>11</th> <td>[[<code>SHOW SLAVE STATUS</code><code>User_password</code>]</td> <td>[[<code>SHOW SLAVE STATUS</code><code>SHOW SLAVE STATUS</code>]</td> <td>O caminho para os certificados da Autoridade de Certificação (CA)</td> </tr><tr> <th>12</th> <td>[[<code>SHOW SLAVE STATUS</code><code>Port</code>]</td> <td>[[<code>SHOW SLAVE STATUS</code><code>Master_Port</code>]</td> <td>Nome do arquivo do certificado SSL</td> </tr><tr> <th>13</th> <td>[[<code>SHOW SLAVE STATUS</code><code>Connect_retry</code>]</td> <td>[[<code>SHOW SLAVE STATUS</code><code>Connect_Retry</code>]</td> <td>A lista de possíveis cifrados usados no handshake para a conexão SSL</td> </tr><tr> <th>14</th> <td>[[<code>SHOW SLAVE STATUS</code><code>Enabled_ssl</code>]</td> <td>[[<code>SHOW SLAVE STATUS</code><code>Master_SSL_Allowed</code>]</td> <td>Nome do arquivo de chave SSL</td> </tr><tr> <th>15</th> <td>[[<code>Number_of_lines</code><code>User_name</code>]</td> <td>[[<code>Number_of_lines</code><code>User_name</code>]</td> <td>Verificar o certificado do servidor</td> </tr><tr> <th>16</th> <td>[[<code>Number_of_lines</code><code>User_password</code>]</td> <td>[Nenhu<code>User_name</code></td> <td>Intervalo entre os batimentos cardíacos de replicação, em segundos</td> </tr><tr> <th>17</th> <td>[[<code>Number_of_lines</code><code>SHOW SLAVE STATUS</code>]</td> <td>[[<code>Number_of_lines</code><code>Port</code>]</td> <td>Qual das interfaces de rede da réplica deve ser usada para se conectar à fonte</td> </tr><tr> <th>18</th> <td>[[<code>Number_of_lines</code><code>Master_Port</code>]</td> <td>[[<code>Number_of_lines</code><code>Connect_retry</code>]</td> <td>A lista de IDs de servidor a serem ignorados. Observe que, para [[<code>Number_of_lines</code><code>Connect_Retry</code>], a lista de IDs de servidor é precedida pelo número total de IDs de servidor a serem ignorados.</td> </tr><tr> <th>19</th> <td>[[<code>Number_of_lines</code><code>Enabled_ssl</code>]</td> <td>[[<code>Number_of_lines</code><code>Master_SSL_Allowed</code>]</td> <td>O ID único da fonte</td> </tr><tr> <th>20</th> <td>[[<code>Master_log_name</code><code>User_name</code>]</td> <td>[[<code>Master_log_name</code><code>User_name</code>]</td> <td>Número máximo de tentativas de reconexão permitidas</td> </tr><tr> <th>21</th> <td>[[<code>Master_log_name</code><code>User_password</code>]</td> <td>[Nenhu<code>User_name</code></td> <td>Caminho para um arquivo de lista de revogação de certificado SSL</td> </tr><tr> <th>22</th> <td>[[<code>Master_log_name</code><code>SHOW SLAVE STATUS</code>]</td> <td>[Nenhu<code>User_name</code></td> <td>Caminho para um diretório contendo arquivos da lista de revogação de certificados SSL</td> </tr><tr> <th>23</th> <td>[[<code>Master_log_name</code><code>Port</code>]</td> <td>[[<code>Master_log_name</code><code>Master_Port</code>]</td> <td>Se o autoposicionamento estiver em uso ou não</td> </tr><tr> <th>24</th> <td>[[<code>Master_log_name</code><code>Connect_retry</code>]</td> <td>[[<code>Master_log_name</code><code>Connect_Retry</code>]</td> <td>O nome do canal de replicação</td> </tr><tr> <th>25</th> <td>[[<code>Master_log_name</code><code>Enabled_ssl</code>]</td> <td>[[<code>Master_log_name</code><code>Master_SSL_Allowed</code>]</td> <td>Versão TLS na fonte</td> </tr></tbody></table>

Para o repositório de metadados do aplicativo, a tabela a seguir mostra a correspondência entre as colunas da tabela `mysql.slave_relay_log_info`, as colunas exibidas pelo [`SHOW SLAVE STATUS`](show-slave-status.html) e as linhas no arquivo `relay-log.info`.

<table summary="A correspondência entre as linhas no arquivo relay-log.info, as colunas na tabela mysql.slave_relay_log_info e as colunas exibidas pelo comando SHOW SLAVE STATUS."><col style="width: 15%"/><col style="width: 30%"/><col style="width: 40%"/><col style="width: 20%"/><thead><tr> <th>Linha em [[PH_HTML_CODE_<code>Master_log_pos</code>]</th> <th>[[PH_HTML_CODE_<code>Master_log_pos</code>] Coluna da tabela</th> <th>[[PH_HTML_CODE_<code>Sql_delay</code>] Coluna</th> <th>Descrição</th> </tr></thead><tbody><tr> <th>1</th> <td>[[PH_HTML_CODE_<code>SQL_Delay</code>]</td> <td>[Nenhu<code>Master_log_pos</code></td> <td>Número de linhas no arquivo ou de colunas na tabela</td> </tr><tr> <th>2</th> <td>[[PH_HTML_CODE_<code>Number_of_workers</code>]</td> <td>[[PH_HTML_CODE_<code>Id</code>]</td> <td>O nome do arquivo de registro atual do relé</td> </tr><tr> <th>3</th> <td>[[PH_HTML_CODE_<code>Channel_name</code>]</td> <td>[[<code>Relay_Log_Pos</code>]]</td> <td>A posição atual dentro do arquivo de registro do relé; os eventos até essa posição foram executados no banco de dados da replica</td> </tr><tr> <th>4</th> <td>[[<code>Master_log_name</code>]]</td> <td>[[<code>Relay_Master_Log_File</code>]]</td> <td>O nome do arquivo de log binário da fonte a partir do qual os eventos no arquivo de log de retransmissão foram lidos</td> </tr><tr> <th>5</th> <td>[[<code>Master_log_pos</code>]]</td> <td>[[<code>slave_relay_log_info</code><code>Master_log_pos</code>]</td> <td>A posição equivalente dentro do arquivo de log binário da fonte de eventos que já foram executados</td> </tr><tr> <th>6</th> <td>[[<code>Sql_delay</code>]]</td> <td>[[<code>SQL_Delay</code>]]</td> <td>O número de segundos que a réplica deve ficar atrasada em relação à fonte</td> </tr><tr> <th>7</th> <td>[[<code>Number_of_workers</code>]]</td> <td>[Nenhu<code>Master_log_pos</code></td> <td>Número de threads de trabalhador na replica para executar eventos de replicação (transações) em paralelo</td> </tr><tr> <th>8</th> <td>[[<code>Id</code>]]</td> <td>[Nenhu<code>Master_log_pos</code></td> <td>ID usado para fins internos; atualmente, este é sempre 1</td> </tr><tr> <th>9</th> <td>[[<code>Channel_name</code>]]</td> <td>Canal_name</td> <td>O nome do canal de replicação</td> </tr></tbody></table>

Em versões do MySQL anteriores ao MySQL 5.6, o arquivo `relay-log.info` não inclui uma contagem de linhas ou um valor de atraso (e a tabela `slave_relay_log_info` não está disponível).

<table summary="A correspondência entre as linhas no arquivo relay-log.info e os itens que aparecem na coluna Status."><col style="width: 15%"/><col style="width: 35%"/><col style="width: 50%"/><thead><tr> <th>Linha</th> <th>Coluna de Status</th> <th>Descrição</th> </tr></thead><tbody><tr> <th>1</th> <td>[[<code>Relay_Log_File</code>]]</td> <td>O nome do arquivo de registro atual do relé</td> </tr><tr> <th>2</th> <td>[[<code>Relay_Log_Pos</code>]]</td> <td>A posição atual dentro do arquivo de registro do relé; os eventos até essa posição foram executados no banco de dados da replica</td> </tr><tr> <th>3</th> <td>[[<code>Relay_Master_Log_File</code>]]</td> <td>O nome do arquivo de log binário da fonte a partir do qual os eventos no arquivo de log de retransmissão foram lidos</td> </tr><tr> <th>4</th> <td>[[<code>Exec_Master_Log_Pos</code>]]</td> <td>A posição equivalente dentro do arquivo de log binário da fonte de eventos que já foram executados</td> </tr></tbody></table>

Nota

Se você descer um servidor de réplica para uma versão mais antiga do MySQL 5.6, o servidor mais antigo não lê o arquivo `relay-log.info` corretamente. Para resolver isso, modifique o arquivo em um editor de texto, excluindo a linha inicial que contém o número de linhas.

O conteúdo do arquivo `relay-log.info` e os estados exibidos pela instrução `SHOW SLAVE STATUS` podem não corresponder se o arquivo `relay-log.info` não tiver sido descarregado no disco. Idealmente, você deve visualizar `relay-log.info` em uma replica que esteja offline (ou seja, o `mysqld` não esteja em execução). Para um sistema em execução, você pode usar `SHOW SLAVE STATUS` ou consultar as tabelas `mysql.slave_master_info` e `mysql.slave_relay_log_info` se você estiver escrevendo os repositórios de metadados de replicação em tabelas.
