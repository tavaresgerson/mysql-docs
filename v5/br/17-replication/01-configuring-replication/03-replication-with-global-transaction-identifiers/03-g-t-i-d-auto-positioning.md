#### 16.1.3.3 Autoposicionamento do GTID

Os GTIDs substituem os pares de deslocamento de arquivo anteriormente necessários para determinar os pontos de início, parada ou retomada do fluxo de dados entre a fonte e a réplica. Quando os GTIDs estão em uso, todas as informações que a réplica precisa para a sincronização com a fonte são obtidas diretamente do fluxo de dados de replicação.

Para iniciar uma replicação usando a replicação baseada em GTID, não inclua as opções `MASTER_LOG_FILE` ou `MASTER_LOG_POS` na declaração `CHANGE MASTER TO` usada para direcionar a replicação a partir de uma fonte específica. Essas opções especificam o nome do arquivo de log e a posição inicial dentro do arquivo, mas, com GTIDs, a replica não precisa desses dados não locais. Em vez disso, você precisa habilitar a opção `MASTER_AUTO_POSITION`. Para obter instruções completas sobre como configurar e iniciar fontes e replicas usando replicação baseada em GTID, consulte Seção 16.1.3.4, “Configurando a Replicação Usando GTIDs”.

A opção `MASTER_AUTO_POSITION` é desabilitada por padrão. Se a replicação de múltiplas fontes estiver habilitada na replica, você precisa definir essa opção para cada canal de replicação aplicável. Desabilitar novamente a opção `MASTER_AUTO_POSITION` faz com que a replica volte à replicação baseada em posição.

Quando uma replica tem os GTIDs habilitados (`GTID_MODE=ON`, `ON_PERMISSIVE` ou `OFF_PERMISSIVE`) e a opção `MASTER_AUTO_POSITION` habilitada, a autoposição é ativada para a conexão com a fonte. A fonte deve ter `GTID_MODE=ON` definido para que a conexão seja bem-sucedida. No handshake inicial, a replica envia um conjunto de GTIDs que contém as transações que ela já recebeu, comprometeu ou ambas. Este conjunto de GTIDs é igual à união do conjunto de GTIDs na variável de sistema `@@GLOBAL.gtid_executed` e do conjunto de GTIDs registrados na tabela do Schema de Desempenho `replication_connection_status` (o resultado da declaração `SELECT RECEIVED_TRANSACTION_SET FROM PERFORMANCE_SCHEMA.replication_connection_status`).

A fonte responde enviando todas as transações registradas em seu log binário cujo GTID não está incluído no conjunto de GTIDs enviado pela replica. Para isso, a fonte primeiro identifica o arquivo de log binário apropriado para começar a trabalhar, verificando o `Previous_gtids_log_event` (evento de log binário anterior) no cabeçalho de cada um de seus arquivos de log binário, começando pelo mais recente. Quando a fonte encontra o primeiro `Previous_gtids_log_event` (evento de log binário anterior) que não contém transações que a replica está faltando, ela começa com esse arquivo de log binário. Esse método é eficiente e leva apenas um tempo significativo se a replica estiver atrasada em relação à fonte por um grande número de arquivos de log binário. A fonte então lê as transações nesse arquivo de log binário e em arquivos subsequentes até o atual, enviando as transações com GTIDs (identificador de transação) que a replica está faltando, e ignorando as transações que estavam no conjunto de GTIDs enviado pela replica. O tempo decorrido até que a replica receba a primeira transação faltante depende de seu deslocamento no arquivo de log binário. Essa troca garante que a fonte só envie as transações com um GTID (identificador de transação) que a replica ainda não recebeu ou não comprometeu. Se a replica receber transações de mais de uma fonte, como no caso de uma topologia de diamante, a função de auto-salto garante que as transações não sejam aplicadas duas vezes.

Se alguma das transações que deveriam ser enviadas pela fonte tiver sido excluída do log binário da fonte ou adicionada ao conjunto de GTIDs na variável de sistema `gtid_purged` por outro método, a fonte envia o erro `ER_MASTER_HAS_PURGED_REQUIRED_GTIDS` para a replica, e a replica não começa a se replicar. Os GTIDs das transações excluídas são identificados e listados no log de erro da fonte na mensagem de aviso `ER_FOUND_MISSING_GTIDS`. A replica não pode se recuperar automaticamente desse erro porque partes do histórico de transações necessárias para recuperar o que a fonte perdeu foram excluídas. Tentar se reconectar sem a opção `MASTER_AUTO_POSITION` habilitada apenas resulta na perda das transações excluídas na replica. A abordagem correta para se recuperar dessa situação é a replica replicar as transações ausentes listadas na mensagem `ER_FOUND_MISSING_GTIDS` de outra fonte, ou substituir a replica por uma nova replica criada a partir de um backup mais recente. Considere revisar o período de expiração do log binário na fonte para garantir que a situação não ocorra novamente.

Se, durante a troca de transações, for constatado que a replica recebeu ou realizou transações com o UUID da fonte no GTID, mas a fonte não tem registro delas, a fonte envia o erro `ER_SLAVE_HAS_MORE_GTIDS_THAN_MASTER` para a replica e a replica não começa a se replicar. Essa situação pode ocorrer se uma fonte que não tem o valor definido em `sync_binlog=1` experimentar uma falha de energia ou um travamento do sistema operacional e perder transações comprometidas que ainda não foram sincronizadas para o arquivo de log binário, mas foram recebidas pela replica. A fonte e a replica podem divergir se algum cliente comprometer transações na fonte após ela ser reiniciada, o que pode levar à situação em que a fonte e a replica estão usando o mesmo GTID para transações diferentes. A abordagem correta para se recuperar dessa situação é verificar manualmente se a fonte e a replica divergiram. Se o mesmo GTID estiver sendo usado agora para transações diferentes, você precisa realizar a resolução manual de conflitos para transações individuais conforme necessário ou remover a fonte ou a replica da topologia de replicação. Se o problema for apenas a falta de transações na fonte, você pode transformar a fonte em uma replica, permitir que ela recupere os outros servidores na topologia de replicação e, se necessário, torná-la novamente uma fonte.
