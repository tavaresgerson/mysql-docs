#### 16.4.1.19 Replicação e max\_allowed\_packet

`max_allowed_packet` define um limite superior para o tamanho de qualquer mensagem única entre o servidor MySQL e os clientes, incluindo as réplicas. Se você estiver replicando valores de coluna grandes (como os encontrados nas colunas `TEXT` ou `BLOB` e `max_allowed_packet` for muito pequeno na fonte, a fonte falhará com um erro e a replica encerrará o fio de I/O de replicação. Se `max_allowed_packet` for muito pequeno na replica, isso também fará com que a replica pare o fio de I/O de replicação.

A replicação baseada em linhas envia todas as colunas e valores das colunas das linhas atualizadas da fonte para a replica, incluindo valores de colunas que não foram realmente alterados pela atualização. Isso significa que, ao replicar grandes valores de coluna usando a replicação baseada em linhas, você deve ter cuidado para definir `max_allowed_packet` grande o suficiente para acomodar a maior linha de qualquer tabela a ser replicada, mesmo que você esteja replicando apenas atualizações ou esteja inserindo apenas valores relativamente pequenos.

Em uma replicação multi-threads (`slave_parallel_workers > 0`), certifique-se de que a variável de sistema `slave_pending_jobs_size_max` esteja definida para um valor igual ou maior que a configuração da variável de sistema `max_allowed_packet` na fonte. O ajuste padrão para `slave_pending_jobs_size_max`, 128M, é o dobro do ajuste padrão para `max_allowed_packet`, que é 64M. `max_allowed_packet` limita o tamanho do pacote que a fonte pode enviar, mas a adição de um cabeçalho de evento pode produzir um evento de log binário que exceda esse tamanho. Além disso, na replicação baseada em linhas, um único evento pode ser significativamente maior que o tamanho de `max_allowed_packet`, porque o valor de `max_allowed_packet` limita apenas cada coluna da tabela.

A réplica realmente aceita pacotes até o limite definido por sua configuração `slave_max_allowed_packet`, que por padrão é o máximo de 1 GB, para evitar uma falha de replicação devido a um pacote grande. No entanto, o valor de `slave_pending_jobs_size_max` controla a memória que é disponibilizada na réplica para armazenar pacotes recebidos. A memória especificada é compartilhada entre todas as filas de trabalho da réplica.

O valor de `slave_pending_jobs_size_max` é um limite flexível, e se um evento incomum (constituído por um ou vários pacotes) exceder esse tamanho, a transação é suspensa até que todas as filas dos trabalhadores da replica estejam vazias e, então, processada. Todas as transações subsequentes são suspensas até que a grande transação seja concluída. Portanto, embora eventos incomuns maiores que `slave_pending_jobs_size_max` possam ser processados, o atraso para limpar as filas de todos os trabalhadores da replica e a espera para colocar as transações subsequentes na fila podem causar atraso na replica e diminuição da concorrência dos trabalhadores da replica. Portanto, `slave_pending_jobs_size_max` deve ser definido com um valor suficientemente alto para acomodar a maioria dos tamanhos esperados dos eventos.
