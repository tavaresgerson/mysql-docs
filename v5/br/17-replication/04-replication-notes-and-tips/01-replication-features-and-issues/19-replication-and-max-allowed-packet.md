#### 16.4.1.19 Replication e max_allowed_packet

[`max_allowed_packet`](server-system-variables.html#sysvar_max_allowed_packet) define um limite superior para o tamanho de qualquer mensagem individual entre o MySQL server e os clients, incluindo as replicas. Se você estiver replicando valores de colunas grandes (como os que podem ser encontrados em colunas [`TEXT`](blob.html "11.3.4 The BLOB and TEXT Types") ou [`BLOB`](blob.html "11.3.4 The BLOB and TEXT Types") ) e o [`max_allowed_packet`](server-system-variables.html#sysvar_max_allowed_packet) for muito pequeno no source, o source falha com um erro, e a replica encerra o replication I/O thread. Se o [`max_allowed_packet`](server-system-variables.html#sysvar_max_allowed_packet) for muito pequeno na replica, isso também faz com que a replica pare o replication I/O thread.

A Replicação baseada em linhas (Row-based replication) envia todas as colunas e valores de colunas para as rows atualizadas do source para a replica, incluindo valores de colunas que não foram de fato alterados pelo update. Isso significa que, ao replicar valores de colunas grandes usando replicação baseada em linhas, você deve tomar cuidado para definir [`max_allowed_packet`](server-system-variables.html#sysvar_max_allowed_packet) grande o suficiente para acomodar a maior row em qualquer table a ser replicada, mesmo que você esteja replicando apenas updates, ou esteja inserindo apenas valores relativamente pequenos.

Em uma replica multi-threaded ([`slave_parallel_workers > 0`](replication-options-replica.html#sysvar_slave_parallel_workers)), garanta que a system variable [`slave_pending_jobs_size_max`](replication-options-replica.html#sysvar_slave_pending_jobs_size_max) esteja definida com um valor igual ou maior do que a configuração da system variable [`max_allowed_packet`](server-system-variables.html#sysvar_max_allowed_packet) no source. A configuração padrão para [`slave_pending_jobs_size_max`](replication-options-replica.html#sysvar_slave_pending_jobs_size_max), 128M, é o dobro da configuração padrão para [`max_allowed_packet`](server-system-variables.html#sysvar_max_allowed_packet), que é 64M. O [`max_allowed_packet`](server-system-variables.html#sysvar_max_allowed_packet) limita o tamanho do packet que o source pode enviar, mas a adição de um cabeçalho de evento pode produzir um evento de binary log que excede esse tamanho. Além disso, na replicação baseada em linhas, um único evento pode ser significativamente maior do que o tamanho do [`max_allowed_packet`](server-system-variables.html#sysvar_max_allowed_packet), porque o valor de [`max_allowed_packet`](server-system-variables.html#sysvar_max_allowed_packet) limita apenas cada coluna da table.

A replica, na verdade, aceita packets até o limite definido por sua configuração [`slave_max_allowed_packet`](replication-options-replica.html#sysvar_slave_max_allowed_packet), que por padrão é o máximo de 1GB, para evitar uma falha de replication devido a um packet grande. No entanto, o valor de [`slave_pending_jobs_size_max`](replication-options-replica.html#sysvar_slave_pending_jobs_size_max) controla a memória que é disponibilizada na replica para reter os packets de entrada. A memória especificada é compartilhada entre todas as filas (queues) de *worker* da replica.

O valor de [`slave_pending_jobs_size_max`](replication-options-replica.html#sysvar_slave_pending_jobs_size_max) é um soft limit (limite flexível) e, se um evento excepcionalmente grande (consistindo em um ou múltiplos packets) exceder esse tamanho, a transaction é retida até que todos os replica workers tenham suas filas vazias, e só então é processada. Todas as transactions subsequentes são retidas até que a transaction grande seja concluída. Assim, embora eventos incomuns maiores que [`slave_pending_jobs_size_max`](replication-options-replica.html#sysvar_slave_pending_jobs_size_max) possam ser processados, o atraso para limpar as filas de todos os replica workers e a espera para enfileirar transactions subsequentes podem causar latência (lag) na replica e diminuir a concorrência dos replica workers. Portanto, [`slave_pending_jobs_size_max`](replication-options-replica.html#sysvar_slave_pending_jobs_size_max) deve ser definido com um valor alto o suficiente para acomodar a maioria dos tamanhos de eventos esperados.