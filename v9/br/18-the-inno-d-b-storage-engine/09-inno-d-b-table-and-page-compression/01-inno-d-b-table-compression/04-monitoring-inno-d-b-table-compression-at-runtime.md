#### 17.9.1.4 Monitoramento da Compressão de Tabelas InnoDB em Tempo Real

O desempenho geral da aplicação, a utilização da CPU e do I/O, e o tamanho dos arquivos de disco são bons indicadores de quão eficaz a compressão é para sua aplicação. Esta seção baseia-se nos conselhos de ajuste de desempenho da Seção 17.9.1.3, “Ajuste da Compressão para Tabelas InnoDB”, e mostra como encontrar problemas que podem não aparecer durante os testes iniciais.

Para explorar mais as considerações de desempenho para tabelas comprimidas, você pode monitorar o desempenho da compressão em tempo real usando as tabelas do Schema de Informações descritas no Exemplo 17.1, “Usando as Tabelas do Schema de Informações de Compressão”. Essas tabelas refletem o uso interno de memória e as taxas de compressão usadas no geral.

A tabela `INNODB_CMP` relata informações sobre a atividade de compressão para cada tamanho de página comprimida (`KEY_BLOCK_SIZE`) em uso. As informações nessas tabelas são de âmbito sistêmico: elas resumem as estatísticas de compressão em todas as tabelas comprimidas em seu banco de dados. Você pode usar esses dados para ajudar a decidir se deve ou não comprimir uma tabela, examinando essas tabelas quando nenhuma outra tabela comprimida estiver sendo acessada. Isso envolve um overhead relativamente baixo no servidor, então você pode fazer uma consulta periodicamente em um servidor de produção para verificar a eficiência geral do recurso de compressão.

A tabela `INNODB_CMP_PER_INDEX` relata informações sobre a atividade de compressão para tabelas e índices individuais. Essas informações são mais direcionadas e mais úteis para avaliar a eficiência da compressão e diagnosticar problemas de desempenho uma tabela ou índice de cada vez. (Como cada tabela `InnoDB` é representada como um índice agrupado, o MySQL não faz uma grande distinção entre tabelas e índices nesse contexto.) A tabela `INNODB_CMP_PER_INDEX` envolve um overhead substancial, portanto, é mais adequada para servidores de desenvolvimento, onde você pode comparar os efeitos de diferentes cargas de trabalho, dados e configurações de compressão isoladamente. Para evitar impor esse overhead de monitoramento acidentalmente, você deve habilitar a opção de configuração `innodb_cmp_per_index_enabled` antes de poder consultar a tabela `INNODB_CMP_PER_INDEX`.

As estatísticas principais a serem consideradas são o número de operações de compressão e descompressão realizadas, bem como o tempo gasto executando essas operações. Como o MySQL divide os nós da árvore B quando estão muito cheios para conter os dados comprimidos após uma modificação, compare o número de operações de compressão “sucedidas” com o número total dessas operações. Com base nas informações nas tabelas `INNODB_CMP` e `INNODB_CMP_PER_INDEX` e no desempenho geral do aplicativo e na utilização dos recursos do hardware, você pode fazer alterações na configuração do hardware, ajustar o tamanho do pool de buffers, escolher um tamanho de página diferente ou selecionar um conjunto diferente de tabelas para compressão.

Se o tempo de CPU necessário para compressão e descompactação for alto, mudar para CPUs mais rápidas ou multi-core pode ajudar a melhorar o desempenho com os mesmos dados, carga de trabalho da aplicação e conjunto de tabelas compactadas. Aumentar o tamanho do pool de buffers também pode ajudar o desempenho, para que mais páginas não compactadas possam permanecer na memória, reduzindo a necessidade de descompactação de páginas que existem na memória apenas em forma compactada.

Um grande número de operações de compressão no geral (comparado ao número de operações `INSERT`, `UPDATE` e `DELETE` na sua aplicação e ao tamanho do banco de dados) pode indicar que algumas de suas tabelas compactadas estão sendo atualizadas demais para uma compressão eficaz. Se for o caso, escolha um tamanho de página maior ou seja mais seletivo sobre quais tabelas você compactua.

Se o número de operações de compressão “sucedidas” (`COMPRESS_OPS_OK`) for uma alta porcentagem do número total de operações de compressão (`COMPRESS_OPS`), então o sistema provavelmente está funcionando bem. Se a proporção for baixa, então o MySQL está reorganizando, recompacando e dividindo nós de árvore B com mais frequência do que seria desejável. Nesse caso, evite comprimir algumas tabelas ou aumente `KEY_BLOCK_SIZE` para algumas das tabelas compactadas. Você pode desativar a compressão para tabelas que fazem com que o número de “falhas de compressão” na sua aplicação seja maior que 1% ou 2% do total. (Tal proporção de falhas pode ser aceitável durante uma operação temporária, como uma carga de dados).