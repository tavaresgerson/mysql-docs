### 17.8.4 Configurando a Concorrência de Fios para o InnoDB

O `InnoDB` utiliza threads do sistema operacional para processar solicitações de transações de usuários. (As transações podem emitir muitas solicitações ao `InnoDB` antes de comprometer ou reverter.) Em sistemas operacionais e servidores modernos com processadores multi-core, onde a troca de contexto é eficiente, a maioria das cargas de trabalho funciona bem sem qualquer limite no número de threads concorrentes.

Em situações em que é útil minimizar a troca de contexto entre threads, o `InnoDB` pode usar várias técnicas para limitar o número de threads do sistema operacional que estão executando simultaneamente (e, portanto, o número de solicitações que são processadas de uma só vez). Quando o `InnoDB` recebe uma nova solicitação de uma sessão de usuário, se o número de threads que estão executando simultaneamente estiver em um limite pré-definido, a nova solicitação dorme por um curto período antes de tentar novamente. Os threads que estão esperando por bloqueios não são contados no número de threads que estão executando simultaneamente.

Você pode limitar o número de threads concorrentes configurando o parâmetro de configuração `innodb_thread_concurrency`. Uma vez que o número de threads em execução atinja esse limite, threads adicionais dormem por um número de microsegundos, definido pelo parâmetro de configuração `innodb_thread_sleep_delay`, antes de serem colocados na fila.

Você pode definir a opção de configuração `innodb_adaptive_max_sleep_delay` para o maior valor que você permitiria para `innodb_thread_sleep_delay`, e o `InnoDB` ajusta automaticamente `innodb_thread_sleep_delay` para cima ou para baixo, dependendo da atividade atual de agendamento de threads. Esse ajuste dinâmico ajuda o mecanismo de agendamento de threads a funcionar de forma suave durante momentos em que o sistema está levemente carregado e quando está operando próximo da capacidade máxima.

O valor padrão para `innodb_thread_concurrency` e o limite padrão implícito no número de threads concorrentes foram alterados em várias versões do MySQL e do `InnoDB`. O valor padrão de `innodb_thread_concurrency` é `0`, de modo que, por padrão, não há limite no número de threads que podem ser executados simultaneamente.

O `InnoDB` faz com que os threads durmam apenas quando o número de threads concorrentes é limitado. Quando não há limite no número de threads, todos competem igualmente para serem agendados. Ou seja, se `innodb_thread_concurrency` for `0`, o valor de `innodb_thread_sleep_delay` é ignorado.

Quando há um limite no número de threads (quando `innodb_thread_concurrency` é > 0), o `InnoDB` reduz o overhead da troca de contexto ao permitir que múltiplos pedidos feitos durante a execução de uma única instrução SQL entrem no `InnoDB` sem observar o limite definido por `innodb_thread_concurrency`. Como uma instrução SQL (como uma junção) pode incluir múltiplas operações de linha no `InnoDB`, o `InnoDB` atribui um número especificado de “ingressos” que permitem que um thread seja agendado repetidamente com um overhead mínimo.

Quando uma nova instrução SQL começa, um fio não tem ingressos e deve observar `innodb_thread_concurrency`. Uma vez que o fio tem direito de entrar no `InnoDB`, ele recebe um número de ingressos que pode usar para entrar no `InnoDB` posteriormente para realizar operações de linha. Se os ingressos acabarem, o fio é despejado e `innodb_thread_concurrency` é observado novamente, o que pode colocar o fio de volta na fila de espera de fios que entram primeiro. Quando o fio tem direito de entrar no `InnoDB` novamente, os ingressos são atribuídos novamente. O número de ingressos atribuídos é especificado pela opção global `innodb_concurrency_tickets`, que é 5000 por padrão. Um fio que está esperando por um bloqueio recebe um ingresso assim que o bloqueio fica disponível.

Os valores corretos dessas variáveis dependem do seu ambiente e da carga de trabalho. Experimente uma gama de valores diferentes para determinar qual valor funciona para suas aplicações. Antes de limitar o número de fios que podem ser executados simultaneamente, revise as opções de configuração que podem melhorar o desempenho do `InnoDB` em computadores multi-core e multi-processador, como `innodb_adaptive_hash_index`.

Para informações gerais sobre o desempenho do MySQL em relação ao tratamento de fios, consulte a Seção 7.1.12.1, “Interfaces de Conexão”.