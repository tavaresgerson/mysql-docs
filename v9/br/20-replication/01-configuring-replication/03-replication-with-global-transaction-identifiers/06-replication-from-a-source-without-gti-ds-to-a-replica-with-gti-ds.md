#### 19.1.3.6 Replicação a partir de uma fonte sem GTIDs para uma réplica com GTIDs

Você pode configurar canais de replicação para atribuir um GTID às transações replicadas que ainda não possuem um. Essa funcionalidade permite a replicação a partir de um servidor de origem que não tem GTIDs habilitados e não usa replicação baseada em GTIDs, para uma réplica que tem GTIDs habilitados. Se for possível habilitar GTIDs no servidor de origem de replicação, conforme descrito na Seção 19.1.4, “Mudando o modo GTID em servidores online”, use essa abordagem. Essa funcionalidade é projetada para servidores de origem de replicação onde você não pode habilitar GTIDs. Observe que, conforme é padrão para a replicação do MySQL, essa funcionalidade não suporta replicação a partir de servidores de origem MySQL anteriores à série de lançamentos anteriores, portanto, o MySQL 9.4 é a fonte mais antiga suportada para uma réplica do MySQL 9.5.

Você pode habilitar a atribuição de GTID em um canal de replicação usando a opção `ASSIGN_GTIDS_TO_ANONYMOUS_TRANSACTIONS` da instrução `CHANGE REPLICATION SOURCE TO`. `LOCAL` atribui um GTID que inclui o próprio UUID da réplica (o ajuste `server_uuid`). `uuid` atribui um GTID que inclui o UUID especificado, como o ajuste `server_uuid` do servidor de origem de replicação. Usar um UUID não local permite diferenciar entre transações que se originaram na réplica e transações que se originaram na origem, e, para uma réplica de múltiplas origens, entre transações que se originaram em diferentes origens. Se alguma das transações enviadas pela origem já tiver um GTID, esse GTID é mantido.

Importante

Um conjunto de replicação configurado com `ASSIGN_GTIDS_TO_ANONYMOUS_TRANSACTIONS` em qualquer canal não pode ser promovido para substituir o servidor de origem da replicação caso seja necessário o failover, e um backup feito da replica não pode ser usado para restaurar o servidor de origem da replicação. A mesma restrição se aplica à substituição ou restauração de outras réplicas que utilizam `ASSIGN_GTIDS_TO_ANONYMOUS_TRANSACTIONS` em qualquer canal.

A replicação deve ter o `gtid_mode=ON` configurado, e isso não pode ser alterado posteriormente, a menos que você configure `ASSIGN_GTIDS_TO_ANONYMOUS_TRANSACTIONS=OFF`. Se o servidor de replicação for iniciado sem GTIDs habilitados e com `ASSIGN_GTIDS_TO_ANONYMOUS_TRANSACTIONS` configurado para qualquer canal de replicação, as configurações não são alteradas, mas uma mensagem de aviso é escrita no log de erro explicando como alterar a situação.

Para uma replicação de múltiplas fontes, você pode ter uma mistura de canais que utilizam `ASSIGN_GTIDS_TO_ANONYMOUS_TRANSACTIONS` e canais que não o fazem. Canais específicos para a Replicação em Grupo não podem usar `ASSIGN_GTIDS_TO_ANONYMOUS_TRANSACTIONS`, mas um canal de replicação assíncrona para outra fonte em uma instância de servidor que é membro de um grupo de Replicação em Grupo pode fazê-lo. Para um canal em um membro de grupo de Replicação em Grupo, não especifique o nome do grupo de Replicação em Grupo como o UUID para a criação dos GTIDs.

Usar `ASSIGN_GTIDS_TO_ANONYMOUS_TRANSACTIONS` em um canal de replicação não é o mesmo que introduzir a replicação baseada em GTID para o canal. O conjunto de GTID (`gtid_executed`) de um conjunto de réplicas configurado com `ASSIGN_GTIDS_TO_ANONYMOUS_TRANSACTIONS` não deve ser transferido para outro servidor ou comparado com o conjunto `gtid_executed` de outro servidor. Os GTIDs atribuídos às transações anônimas e o UUID que você escolher para eles têm significado apenas para o uso exclusivo daquela réplica. A exceção a isso é qualquer réplica descendente da réplica onde você habilitou `ASSIGN_GTIDS_TO_ANONYMOUS_TRANSACTIONS`, e qualquer servidor criado a partir de um backup dessa réplica.

Se você configurar qualquer réplica descendente, esses servidores não têm `ASSIGN_GTIDS_TO_ANONYMOUS_TRANSACTIONS` habilitado. Apenas a réplica que está recebendo transações diretamente do servidor de origem não baseada em GTID precisa ter `ASSIGN_GTIDS_TO_ANONYMOUS_TRANSACTIONS` configurado no canal de replicação relevante. Entre essa réplica e suas réplicas descendentes, você pode comparar os conjuntos de GTID, fazer uma falha de transição de uma réplica para outra e usar backups para criar réplicas adicionais, como faria em qualquer topologia de replicação baseada em GTID. `ASSIGN_GTIDS_TO_ANONYMOUS_TRANSACTIONS` é usado quando as transações são recebidas de um servidor não baseado em GTID fora deste grupo.

Um canal de replicação que usa `ASSIGN_GTIDS_TO_ANONYMOUS_TRANSACTIONS` tem as seguintes diferenças de comportamento em relação à replicação baseada em GTID:

* Os GTIDs são atribuídos às transações replicadas quando elas são aplicadas (a menos que já tenham um GTID). Um GTID normalmente é atribuído no servidor de origem da replicação quando a transação é confirmada e enviado para a replica junto com a transação. Em uma replica multisserial, isso significa que a ordem dos GTIDs não necessariamente corresponde à ordem das transações, mesmo que `replica_preserve_commit_order` = 1.

* As opções `SOURCE_LOG_FILE` e `SOURCE_LOG_POS` da instrução `CHANGE REPLICATION SOURCE TO` são usadas para posicionar o thread de I/O de replicação (receptor), em vez da opção `SOURCE_AUTO_POSITION`.

* A instrução `SET GLOBAL sql_replica_skip_counter` é usada para pular transações em um canal de replicação configurado com `ASSIGN_GTIDS_TO_ANONYMOUS_TRANSACTIONS`, em vez do método de confirmar transações vazias. Para instruções, consulte a Seção 19.1.7.3, “Pular Transações”.

* As opções `UNTIL SQL_BEFORE_GTIDS` e `UNTIL_SQL_AFTER_GTIDS` da instrução `START REPLICA` não podem ser usadas para o canal.

* A função `WAIT_FOR_EXECUTED_GTID_SET()` funciona em todo o servidor e pode ser usada para aguardar por quaisquer réplicas descendentes do servidor que tenham `ASSIGN_GTIDS_TO_ANONYMOUS_TRANSACTIONS` habilitada. Para aguardar pelo canal com `ASSIGN_GTIDS_TO_ANONYMOUS_TRANSACTIONS` habilitado para se atualizar com a fonte, que não usa GTIDs, use a função `SOURCE_POS_WAIT()`.

A tabela do Schema de Desempenho `replication_applier_configuration` mostra se GTIDs são atribuídos a transações anônimas em um canal de replicação, qual é o UUID e se é o UUID do servidor replica (`LOCAL`) ou um UUID especificado pelo usuário (`UUID`). As informações também são registradas no repositório de metadados do aplicável. Uma declaração `RESET REPLICA ALL` redefiniu o ajuste `ASSIGN_GTIDS_TO_ANONYMOUS_TRANSACTIONS`, mas uma declaração `RESET REPLICA` não.