#### 19.2.1.2 Uso do Registro em Linha e Replicação

O MySQL utiliza o registro baseado em instruções (SBL), registro em linha (RBL) ou registro de formato misto. O tipo de log binário usado afeta o tamanho e a eficiência do registro. Portanto, a escolha entre replicação em linha (RBR) ou replicação baseada em instruções (SBR) depende da sua aplicação e do ambiente. Esta seção descreve problemas conhecidos ao usar um log em formato de linha e descreve algumas melhores práticas ao usá-lo na replicação.

Para informações adicionais, consulte a Seção 19.2.1, “Formatos de Replicação”, e a Seção 19.2.1.1, “Vantagens e Desvantagens da Replicação Baseada em Instruções e em Linha”.

Para informações sobre problemas específicos da replicação do NDB Cluster (que depende da replicação em linha), consulte a Seção 25.7.3, “Problemas Conhecidos na Replicação do NDB Cluster”.

* **Registro em linha de tabelas temporárias.** Como observado na Seção 19.5.1.32, “Replicação e Tabelas Temporárias”, as tabelas temporárias não são replicadas ao usar formato em linha ou misto. Para mais informações, consulte a Seção 19.2.1.1, “Vantagens e Desvantagens da Replicação Baseada em Instruções e em Linha”.

As tabelas temporárias não são replicadas ao usar formato em linha ou misto porque não há necessidade. Além disso, como as tabelas temporárias podem ser lidas apenas pelo thread que as criou, raramente, se é que alguma vez, há algum benefício obtido ao replica-las, mesmo quando usando o formato baseado em instruções.

Você pode alternar do formato baseado em instruções para o formato binário de registro em linha em tempo de execução, mesmo quando tabelas temporárias foram criadas, mas não pode alternar do formato em linha ou misto para o formato baseado em instruções em tempo de execução, devido a quaisquer instruções `CREATE TEMPORARY TABLE` terem sido omitidas do log binário no modo anterior.

O servidor MySQL registra o modo de registro que estava em vigor quando cada tabela temporária foi criada. Quando uma sessão de cliente específica termina, o servidor registra uma declaração `DROP TEMPORARY TABLE IF EXISTS` para cada tabela temporária que ainda existe e foi criada quando o registro binário baseado em declarações estava em uso. Se o registro binário baseado em linhas ou misto estava em uso quando a tabela foi criada, a declaração `DROP TEMPORARY TABLE IF EXISTS` não é registrada.

As instruções DML não transacionais que envolvem tabelas temporárias são permitidas ao usar `binlog_format=ROW`, desde que quaisquer tabelas não transacionais afetadas pelas instruções sejam tabelas temporárias.

* **RBL e sincronização de tabelas não transacionais.** Quando muitas linhas são afetadas, o conjunto de alterações é dividido em vários eventos; quando a declaração é confirmada, todos esses eventos são escritos no log binário. Ao executar na replica, uma trava de tabela é tomada em todas as tabelas envolvidas, e então as linhas são aplicadas em modo batch. Dependendo do motor usado para a cópia da tabela da replica, isso pode ou não ser eficaz.

* **Latência e tamanho do log binário.** O RBL escreve alterações para cada linha no log binário e, portanto, seu tamanho pode aumentar bastante rapidamente. Isso pode aumentar significativamente o tempo necessário para fazer alterações na replica que correspondem às do fonte. Você deve estar ciente do potencial desse atraso em suas aplicações.

* **Leitura do log binário.** O **mysqlbinlog** exibe eventos baseados em linhas no log binário usando a instrução `BINLOG`. Esta instrução exibe um evento como uma string codificada em base 64, cujo significado não é evidente. Quando invocado com as opções `--base64-output=DECODE-ROWS` e `--verbose`, o **mysqlbinlog** formata o conteúdo do log binário para ser legível para humanos. Quando eventos do log binário foram escritos em formato baseado em linhas e você deseja ler ou recuperar de uma falha de replicação ou banco de dados, você pode usar este comando para ler o conteúdo do log binário. Para mais informações, consulte a Seção 6.6.9.2, “Exibição de Eventos de Linha do mysqlbinlog”.

* **Erros de execução do log binário e modo de execução da replica.** Usar `replica_exec_mode=IDEMPOTENT` é geralmente útil apenas com a replicação do MySQL NDB Cluster, para a qual `IDEMPOTENT` é o valor padrão. (Veja a Seção 25.7.10, “Replicação do NDB Cluster: Replicação Bidirecional e Circular”). Quando `replica_exec_mode` é `IDEMPOTENT`, uma falha na aplicação de alterações do RBL porque a linha original não pode ser encontrada não dispara um erro ou faz com que a replica falhe. Isso significa que é possível que as atualizações não sejam aplicadas na replica, de modo que a fonte e a replica não estejam mais sincronizadas. Problemas de latência e uso de tabelas não transacionais com RBR quando `replica_exec_mode` é `IDEMPOTENT` podem fazer com que a fonte e a replica se desviem ainda mais. Para mais informações sobre `replica_exec_mode`, consulte a Seção 7.1.8, “Variáveis do Sistema do Servidor”.

* **Para outros cenários, definir `replica_exec_mode` para `STRICT` é normalmente suficiente; este é o valor padrão para motores de armazenamento que não são `NDB`.**

* **Filtragem com base no ID do servidor não é suportada.** Você pode filtrar com base no ID do servidor usando a opção `IGNORE_SERVER_IDS` para `ALTERAR FONTE DE REPLICA`. Esta opção funciona tanto com os formatos de registro baseados em declarações quanto em linhas, mas não pode ser usada quando `gtid_mode=ON`. Outro método para filtrar as alterações em algumas réplicas é usar uma cláusula `WHERE` que inclua a cláusula `@@server_id <> id_value` com as instruções `UPDATE` e `DELETE`. Por exemplo, `WHERE @@server_id <> 1`. No entanto, isso não funciona corretamente com o registro em linhas. Para usar a variável de sistema `server_id` para filtragem de declarações, use o registro em linhas.

* **Tabelas RBL, não transacionais e réplicas paradas.** Ao usar o registro em linhas, se o servidor de réplica for parado enquanto um thread de réplica está atualizando uma tabela não transacional, o banco de dados da réplica pode atingir um estado inconsistente. Por essa razão, recomenda-se que você use um motor de armazenamento transacional, como `InnoDB`, para todas as tabelas replicadas usando o formato em linhas. O uso de `STOP REPLICA` ou `STOP REPLICA SQL_THREAD` antes de desligar o servidor MySQL da réplica ajuda a prevenir problemas e é sempre recomendado, independentemente do formato de registro ou do motor de armazenamento que você usar.