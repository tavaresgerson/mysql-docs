#### 19.4.9.1 Falha no Failover de Conexão Assíncrona para Fontes

Para ativar o failover de conexão assíncrona para uma fonte, defina `SOURCE_CONNECTION_AUTO_FAILOVER=1` em uma declaração `CHANGE REPLICATION SOURCE TO` para este canal. O posicionamento automático do GTID deve estar em uso para o canal (`SOURCE_AUTO_POSITION = 1`).

Importante

Quando a conexão existente com uma fonte falhar, a réplica primeiro tenta a mesma conexão o número de vezes especificado pela opção `SOURCE_RETRY_COUNT` da declaração `CHANGE REPLICATION SOURCE TO`. O intervalo entre as tentativas é definido pela opção `SOURCE_CONNECT_RETRY`. Quando essas tentativas forem esgotadas, o mecanismo de failover de conexão assíncrona assume o controle. Observe que os valores padrão dessas opções, que foram projetados para uma conexão com uma única fonte, fazem com que a réplica tente a mesma conexão por 60 dias. Para garantir que o mecanismo de failover de conexão assíncrona possa ser ativado prontamente, defina `SOURCE_RETRY_COUNT` e `SOURCE_CONNECT_RETRY` para números mínimos que permitam apenas algumas tentativas de reposição com a mesma fonte, caso a falha de conexão seja causada por uma interrupção transitória da rede. Valores adequados são `SOURCE_RETRY_COUNT=3` e `SOURCE_CONNECT_RETRY=10`, que fazem com que a réplica tente a conexão 3 vezes com intervalos de 10 segundos entre elas.

Você também precisa definir a lista de fontes para o canal de replicação, para especificar as fontes disponíveis para o failover. Você define e gerencia listas de fontes usando as funções `asynchronous_connection_failover_add_source` e `asynchronous_connection_failover_delete_source` para adicionar e remover servidores de fonte de replicação individual. Para adicionar e remover grupos gerenciados de servidores, use as funções `asynchronous_connection_failover_add_managed` e `asynchronous_connection_failover_delete_managed` em vez disso.

As funções nomeiam o canal de replicação relevante e especificam o nome do host, o número de porta, o namespace de rede e a prioridade ponderada (1-100, com 100 sendo a prioridade mais alta) de uma instância MySQL para adicionar ou remover da lista de fontes do canal. Para um grupo gerenciado, você também especifica o tipo de serviço gerenciado (atualmente, apenas o Grupo de Replicação está disponível) e o identificador do grupo gerenciado (para o Grupo de Replicação, este é o valor da variável de sistema `group_replication_group_name`). Ao adicionar um grupo gerenciado, você só precisa adicionar um membro do grupo, e a replica adiciona automaticamente o restante da atual composição do grupo. Ao excluir um grupo gerenciado, você exclui todo o grupo junto.

O mecanismo de falha de conexão assíncrona também realiza a transição de conexão se outro servidor disponível na lista de origem tiver uma configuração de prioridade (peso) mais alta. Esse recurso garante que a replica permaneça conectada ao servidor de origem mais adequado em todos os momentos, e ele se aplica tanto a grupos gerenciados quanto a servidores únicos (não gerenciados). Para um grupo gerenciado, o peso de uma fonte é atribuído dependendo se ela é um servidor primário ou secundário. Portanto, assumindo que você configurou o grupo gerenciado para dar um peso maior a um servidor primário e um peso menor a um secundário, quando o primário muda, o peso mais alto é atribuído ao novo primário, então a replica realiza a transição de conexão para ele. O mecanismo de falha de conexão assíncrona também altera a conexão se o servidor de origem gerenciado atualmente conectado sair do grupo gerenciado ou deixar de estar na maioria do grupo gerenciado.

Ao realizar a falha de conexão, a fonte com a configuração de prioridade (peso) mais alta entre as fontes alternativas listadas na lista de origem para o canal é escolhida para a primeira tentativa de conexão. A replica verifica primeiro se pode se conectar ao servidor de origem, ou, no caso de um grupo gerenciado, se o servidor de origem tem o status `ONLINE` no grupo (não `RECOVERING` ou indisponível). Se a fonte com o peso mais alto não estiver disponível, a replica tenta com todas as fontes listadas em ordem decrescente de peso, então começa novamente a partir da fonte com o peso mais alto. Se várias fontes tiverem o mesmo peso, a replica as ordena aleatoriamente. Se a replica precisar começar a trabalhar novamente pela lista, ela inclui e tenta novamente a fonte para a qual a falha original de conexão ocorreu.

As listas de fontes são armazenadas nas tabelas `mysql.replication_asynchronous_connection_failover` e `mysql.replication_asynchronous_connection_failover_managed` e podem ser visualizadas nas tabelas `replication_asynchronous_connection_failover` e `replication_asynchronous_connection_failover_managed` do Schema de Desempenho. A réplica usa um thread de monitoramento para rastrear a associação dos grupos gerenciados e atualizar a lista de fontes (`thread/sql/replica_monitor`). A configuração da opção `SOURCE_CONNECTION_AUTO_FAILOVER` da instrução `CHANGE REPLICATION SOURCE TO` e a lista de fontes são transferidas para um clone da réplica durante uma operação de clonagem remota.