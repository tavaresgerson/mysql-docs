#### 19.5.1.21 Replicação e max_allowed_packet

`max_allowed_packet` define um limite superior para o tamanho de qualquer mensagem única entre o servidor MySQL e os clientes, incluindo as réplicas. Se você estiver replicando valores de coluna grandes (como os encontrados em colunas `TEXT` ou `BLOB`) e `max_allowed_packet` for muito pequeno na fonte, a fonte falhará com um erro, e a réplica desligará o fio de I/O de replicação (receptor). Se `max_allowed_packet` for muito pequeno na réplica, isso também fará com que a réplica pare o fio de I/O.

A replicação baseada em linhas envia todas as colunas e valores de coluna para as linhas atualizadas da fonte para a réplica, incluindo valores de colunas que não foram realmente alteradas pela atualização. Isso significa que, ao replicar valores de coluna grandes usando a replicação baseada em linhas, você deve garantir que `max_allowed_packet` seja grande o suficiente para acomodar a maior linha de qualquer tabela a ser replicada, mesmo que você esteja replicando atualizações apenas ou está inserindo apenas valores relativamente pequenos.

Em uma réplica multi-threaded, certifique-se de que a variável de sistema `replica_pending_jobs_size_max` esteja definida para um valor igual ou maior que a configuração da variável de sistema `max_allowed_packet` na fonte. O ajuste padrão para `replica_pending_jobs_size_max`, 128M, é o dobro do ajuste padrão para `max_allowed_packet`, que é 64M. `max_allowed_packet` limita o tamanho do pacote que a fonte pode enviar, mas a adição de um cabeçalho de evento pode produzir um evento de log binário que exceda esse tamanho. Além disso, na replicação baseada em linhas, um único evento pode ser significativamente maior que o tamanho de `max_allowed_packet`, porque o valor de `max_allowed_packet` limita apenas cada coluna da tabela.

A replica, na verdade, aceita pacotes até o limite definido pela configuração `replica_max_allowed_packet`, que tem como padrão o limite máximo de 1 GB, para evitar uma falha de replicação devido a um pacote grande. No entanto, o valor de `replica_pending_jobs_size_max` controla a memória que é disponibilizada na replica para armazenar pacotes recebidos. A memória especificada é compartilhada entre todas as filas de trabalho da replica.

O valor de `replica_pending_jobs_size_max` é um limite flexível, e se um evento incomum (constituído por um ou vários pacotes) exceder esse tamanho, a transação é suspensa até que todas as filas de trabalho da replica estejam vazias e, então, processada. Todas as transações subsequentes são suspensas até que a grande transação seja concluída. Portanto, embora eventos incomuns maiores que `replica_pending_jobs_size_max` possam ser processados, o atraso para limpar as filas de todos os trabalhadores da replica e a espera para colocar as transações subsequentes na fila podem causar atraso na replica e diminuição da concorrência dos trabalhadores da replica. `replica_pending_jobs_size_max` deve, portanto, ser definido com um valor alto o suficiente para acomodar a maioria dos tamanhos esperados dos eventos.