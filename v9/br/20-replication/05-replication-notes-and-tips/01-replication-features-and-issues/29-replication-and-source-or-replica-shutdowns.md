#### 19.5.1.29 Replicação e Parada de Servidores de Fonte ou Replicação

É seguro desligar um servidor de fonte de replicação e reiniciá-lo mais tarde. Quando uma replica perde sua conexão com a fonte, ela tenta se reconectar imediatamente e tenta novamente periodicamente se isso falhar. O padrão é tentar novamente a cada 60 segundos. Isso pode ser alterado com a instrução `ALTERAR REPLICAÇÃO DE PARA`. Uma replica também é capaz de lidar com interrupções na conectividade da rede. No entanto, a replica só percebe a interrupção da rede após não receber dados da fonte por `replica_net_timeout` segundos. Se suas interrupções forem curtas, você pode querer diminuir o valor de `replica_net_timeout`. Veja a Seção 19.4.2, “Lidando com um Parada Inesperada de uma Replicação”.

Um desligamento não limpo (por exemplo, um crash) no lado da fonte pode resultar no log binário da fonte ter uma posição final menor que a posição mais recente lida pela replica, devido ao arquivo de log binário da fonte não ser esvaziado. Isso pode fazer com que a replica não consiga replicar quando a fonte voltar a funcionar. Definir `sync_binlog=1` no arquivo `my.cnf` do servidor de fonte ajuda a minimizar esse problema, pois faz com que a fonte esvazie seu log binário com mais frequência. Para a maior durabilidade e consistência possíveis em uma configuração de replicação usando `InnoDB` com transações, você também deve definir `innodb_flush_log_at_trx_commit=1`. Com essa configuração, o conteúdo do buffer de log de refazer do `InnoDB` é escrito no arquivo de log a cada commit de transação e o arquivo de log é esvaziado para o disco. Note que a durabilidade das transações ainda não é garantida com essa configuração, porque sistemas operacionais ou hardware de disco podem informar ao **mysqld** que a operação de gravação para o disco já ocorreu, mesmo que não tenha.

Fechar uma replica de forma limpa é seguro, pois ela mantém o registro de onde parou. No entanto, tenha cuidado para que a replica não tenha tabelas temporárias abertas; veja a Seção 19.5.1.32, “Replicação e Tabelas Temporárias”. Fechas não limpas podem causar problemas, especialmente se o cache do disco não tiver sido descarregado no disco antes do problema ocorrer:

* Para transações, a replica confirma e depois atualiza `relay-log.info`. Se uma saída inesperada ocorrer entre essas duas operações, o processamento do log de retransmissão prossegue além do que o arquivo de informações indica e a replica reexecuta os eventos da última transação no log de retransmissão após ser reiniciada.

* Um problema semelhante pode ocorrer se a replica atualizar `relay-log.info` mas o servidor host falhar antes que a escrita seja descarregada no disco. Para minimizar a chance de isso ocorrer, defina `sync_relay_log_info=1` no arquivo `my.cnf` da replica. Definir `sync_relay_log_info` para 0 faz com que as escritas não sejam forçadas ao disco e o servidor depende do sistema operacional para descarregar o arquivo de tempos em tempos.

A tolerância a falhas do seu sistema para esses tipos de problemas é muito aumentada se você tiver uma boa fonte de alimentação ininterrupta.