#### 19.3.2.3 Rotação da Chave do Mestre do Log Binário

Quando a criptografia do log binário está habilitada, você pode rotar a chave do mestre do log binário a qualquer momento enquanto o servidor estiver em execução, emitindo `ALTER INSTANCE ROTATE BINLOG MASTER KEY`. Quando a chave do mestre do log binário é rotada manualmente usando essa instrução, as senhas dos novos e dos arquivos subsequentes são criptografadas usando a nova chave do mestre do log binário, e também as senhas dos arquivos do log de retransmissão e dos arquivos de log de retransmissão existentes são re-criptografadas usando a nova chave do mestre do log binário, de modo que a criptografia seja renovada completamente. Você pode rotar a chave do mestre do log binário regularmente para cumprir a política de segurança da sua organização, e também se você suspeitar que a chave do mestre do log binário atual ou alguma das chaves anteriores possam ter sido comprometidas.

Quando você rota a chave do mestre do log binário manualmente, o MySQL Server executa as seguintes ações em sequência:

1. Uma nova chave de criptografia do log binário é gerada com o próximo número de sequência disponível, armazenada no conjunto de chaves, e usada como a nova chave do mestre do log binário.

2. Os arquivos de log binário e de log de retransmissão são rotados em todos os canais.

3. A nova chave do mestre do log binário é usada para criptografar as senhas dos arquivos do novo log binário e dos arquivos de log de retransmissão e dos arquivos subsequentes até que a chave seja alterada novamente.

4. As senhas dos arquivos de log binário criptografados existentes e dos arquivos de log de retransmissão existentes no servidor são re-criptografadas, uma após a outra, usando a nova chave do mestre do log binário, começando pelos arquivos mais recentes. Quaisquer arquivos não criptografados são ignorados.

5. As chaves de criptografia do log binário que não estão mais em uso para nenhum arquivo após o processo de re-criptografia são removidas do conjunto de chaves.

O privilégio `BINLOG_ENCRYPTION_ADMIN` é necessário para emitir `ALTER INSTANCE ROTATE BINLOG MASTER KEY`, e a declaração não pode ser usada se a variável de sistema `binlog_encryption` estiver definida como `OFF`.

Como o último passo do processo de rotação da chave mestre do log binário, todas as chaves de criptografia do log binário que deixam de se aplicar a quaisquer arquivos de log binário ou arquivos de log de retransmissão retidos são limpas do conjunto de chaves. Se um arquivo de log binário ou arquivo de log de retransmissão retido não puder ser inicializado para re-criptografia, as chaves de criptografia do log binário relevantes não são excluídas, caso os arquivos possam ser recuperados no futuro. Por exemplo, isso pode ser o caso se um arquivo listado em um arquivo de índice de log binário estiver atualmente ilegível ou se um canal não conseguir ser inicializado. Se o UUID do servidor mudar, por exemplo, porque um backup criado usando o MySQL Enterprise Backup é usado para configurar uma nova replica, emitir `ALTER INSTANCE ROTATE BINLOG MASTER KEY` no novo servidor não exclui quaisquer chaves de criptografia do log binário anteriores que incluam o UUID do servidor original.

Se qualquer um dos primeiros quatro passos do processo de rotação da chave mestre do log binário não puder ser completado corretamente, uma mensagem de erro é emitida explicando a situação e as consequências para o status de criptografia dos arquivos de log binário e arquivos de log de retransmissão. Arquivos que foram criptografados anteriormente são sempre deixados em estado criptografado, mas suas senhas de arquivo ainda podem estar criptografadas usando uma chave mestre do log binário antiga. Se você vir esses erros, tente novamente o processo emitindo `ALTER INSTANCE ROTATE BINLOG MASTER KEY` novamente. Em seguida, investigue o status de arquivos individuais para ver o que está bloqueando o processo, especialmente se você suspeitar que as chaves de mestre do log binário atuais ou anteriores possam ter sido comprometidas.

Se a etapa final do processo de rotação da chave mestre do log binário não puder ser concluída corretamente, uma mensagem de aviso é emitida explicando a situação. A mensagem de aviso identifica se o processo não conseguiu limpar as chaves auxiliares no conjunto de chaves ou não conseguiu limpar as chaves de criptografia do log binário não utilizadas. Você pode optar por ignorar a mensagem, pois as chaves são chaves auxiliares ou não estão mais em uso, ou você pode emitir `ALTER INSTANCE ROTATE BINLOG MASTER KEY` novamente para tentar novamente o processo.

Se o servidor parar e for reiniciado com a criptografia do log binário ainda definida como `ON` durante o processo de rotação da chave mestre do log binário, novos arquivos de log binário e arquivos de log de relevo após o reinício serão criptografados usando a nova chave mestre do log binário. No entanto, a re-criptografia de arquivos existentes não é continuada, então arquivos que não foram re-criptografados antes do servidor parar permanecem criptografados usando a chave mestre do log binário anterior. Para completar a re-criptografia e limpar as chaves de criptografia do log binário não utilizadas, emite `ALTER INSTANCE ROTATE BINLOG MASTER KEY` novamente após o reinício.

As ações `ALTER INSTANCE ROTATE BINLOG MASTER KEY` não são escritas no log binário e não são executadas nas réplicas. A rotação da chave mestre do log binário pode, portanto, ser realizada em ambientes de replicação, incluindo uma mistura de versões do MySQL. Para agendar a rotação regular da chave mestre do log binário em todos os servidores de origem e réplicas aplicáveis, você pode habilitar o Cronômetro de Eventos do MySQL em cada servidor e emitir a declaração `ALTER INSTANCE ROTATE BINLOG MASTER KEY` usando uma declaração `CREATE EVENT`. Se você rotar a chave mestre do log binário porque suspeita que a chave mestre do log binário atual ou alguma das chaves anteriores possam ter sido comprometidas, emita a declaração em todos os servidores de origem e réplicas aplicáveis. Emitir a declaração em servidores individuais garante que você possa verificar a conformidade imediata, mesmo no caso de réplicas que estão atrasadas, pertencem a múltiplas topologias de replicação ou não estão atualmente ativas na topologia de replicação, mas têm arquivos de log binário e log de retransmissão.

A variável de sistema `binlog_rotate_encryption_master_key_at_startup` controla se a chave mestre do log binário é rotada automaticamente quando o servidor é reiniciado. Se essa variável de sistema for definida como `ON`, uma nova chave de criptografia do log binário é gerada e usada como a nova chave mestre do log binário sempre que o servidor é reiniciado. Se for definida como `OFF`, que é o padrão, a chave mestre do log binário existente é usada novamente após o reinício. Quando a chave mestre do log binário é rotada no início, as senhas dos arquivos de log binário e log de retransmissão do novo log binário são criptografadas usando a nova chave. As senhas dos arquivos de log binário criptografado existente e dos arquivos de log de retransmissão não são re-criptografadas, portanto, permanecem criptografadas usando a chave antiga, que permanece disponível no chaveiro.