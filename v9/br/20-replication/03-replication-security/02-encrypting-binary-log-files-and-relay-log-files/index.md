### 19.3.2 Criptografia de Arquivos de Log Binários e Arquivos de Log de Retransmissão

19.3.2.1 Âmbito da Criptografia de Arquivos de Log Binários

19.3.2.2 Chaves de Criptografia de Arquivos de Log Binários

19.3.2.3 Rotação da Chave Mestre de Log Binário

Os arquivos de log binários e os arquivos de log de retransmissão do MySQL podem ser criptografados, ajudando a proteger esses arquivos e os dados sensíveis que podem estar contidos neles de serem mal utilizados por atacantes externos, além de serem visualizados por usuários do sistema operacional onde estão armazenados. O algoritmo de criptografia usado para os arquivos, o algoritmo de cifra AES (Padrão de Criptografia Avançada), está integrado ao MySQL Server e não pode ser configurado.

Você habilita essa criptografia em um servidor MySQL configurando a variável de sistema `binlog_encryption` para `ON`. `OFF` é o padrão. A variável de sistema habilita a criptografia para arquivos de log binários e arquivos de log de retransmissão. O registro de log binário não precisa ser habilitado no servidor para habilitar a criptografia, então você pode criptografar os arquivos de log de retransmissão em uma replica que não tem um log binário. Para usar a criptografia, um componente ou plugin de chaveira deve ser instalado e configurado para fornecer o serviço de chaveira do MySQL Server. Para obter instruções sobre como fazer isso, consulte a Seção 8.4.5, “A Chaveira MySQL”. Qualquer componente ou plugin de chaveira suportado pode ser usado para armazenar as chaves de criptografia de log binário.

Quando você inicia o servidor pela primeira vez com a criptografia habilitada, uma nova chave de criptografia do log binário é gerada antes que os logs binários e os logs de retransmissão sejam inicializados. Essa chave é usada para criptografar uma senha de arquivo para cada arquivo de log binário (se o servidor tiver criptografia binária habilitada) e para o arquivo de log de retransmissão (se o servidor tiver canais de replicação), e as chaves adicionais geradas a partir das senhas de arquivo são usadas para criptografar os dados nos arquivos. A chave de criptografia do log binário que está atualmente em uso no servidor é chamada de chave mestre do log binário. A arquitetura de chave de criptografia em duas camadas significa que a chave mestre do log binário pode ser rotada (substituída por uma nova chave mestre) conforme necessário, e apenas a senha de arquivo para cada arquivo precisa ser re-criptografada com a nova chave mestre, não todo o arquivo. Os arquivos de log de retransmissão são criptografados para todos os canais, incluindo novos canais que são criados após a criptografia ser ativada. O arquivo de índice do log binário e o arquivo de índice do log de retransmissão nunca são criptografados.
Se você ativar a criptografia enquanto o servidor estiver em execução, uma nova chave de criptografia do log binário será gerada naquela época. A exceção é se a criptografia estava ativa anteriormente no servidor e foi então desativada, caso em que a chave de criptografia do log binário que estava em uso antes é usada novamente. Os arquivos de log binário e os arquivos de log de retransmissão são rotados imediatamente, e as senhas de arquivo para os novos arquivos e todos os arquivos de log binário subsequentes e os arquivos de log de retransmissão são criptografados usando essa chave de criptografia do log binário. Os arquivos de log binário e os arquivos de log de retransmissão existentes ainda presentes no servidor não são criptografados, mas você pode excluí-los se não forem mais necessários.

Se você desativar a criptografia alterando a variável de sistema `binlog_encryption` para `OFF`, o arquivo de log binário e os arquivos de log de retransmissão serão rotados imediatamente e todo o registro subsequente será descriptografado. Arquivos criptografados anteriormente não serão descriptografados automaticamente, mas o servidor ainda poderá lê-los. O privilégio `BINLOG_ENCRYPTION_ADMIN` é necessário para ativar ou desativar a criptografia enquanto o servidor estiver em execução.

Arquivos de log binário criptografados e não criptografados podem ser distinguidos usando o número mágico no início do cabeçalho do arquivo para arquivos de log criptografados (`0xFD62696E`), que difere do usado para arquivos de log não criptografados (`0xFE62696E`). A instrução `SHOW BINARY LOGS` mostra se cada arquivo de log binário está criptografado ou não.

Quando os arquivos de log binário foram criptografados, o **mysqlbinlog** não pode lê-los diretamente, mas pode lê-los do servidor usando a opção `--read-from-remote-server`. Se você fazer backup de arquivos de log binário criptografados usando o **mysqlbinlog**, observe que as cópias dos arquivos geradas usando o **mysqlbinlog** são armazenadas em um formato não criptografado.

A criptografia do log binário pode ser combinada com a compressão de transações de log binário. Para mais informações sobre compressão de transações de log binário, consulte a Seção 7.4.4.5, “Compressão de Transações de Log Binário”.