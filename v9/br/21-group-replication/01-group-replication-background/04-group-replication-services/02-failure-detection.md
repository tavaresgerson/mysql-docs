#### 20.1.4.2 Detecção de Falha

O mecanismo de detecção de falha da replicação em grupo é um serviço distribuído que é capaz de identificar que um servidor no grupo não está se comunicando com os outros, e, portanto, é suspeito de estar fora de serviço. Se o consenso do grupo for que a suspeita é provavelmente verdadeira, o grupo toma uma decisão coordenada para expulsar o membro. Expulsar um membro que não está se comunicando é necessário porque o grupo precisa de uma maioria de seus membros concordar com uma transação ou mudança de visão. Se um membro não está participando dessas decisões, o grupo deve removê-lo para aumentar a chance de que o grupo contenha uma maioria de membros que estão funcionando corretamente e, portanto, podem continuar processando transações.

Em um grupo de replicação, cada membro tem um canal de comunicação ponto a ponto com cada membro do grupo, criando um gráfico totalmente conectado. Essas conexões são gerenciadas pelo motor de comunicação do grupo (XCom, uma variante do Paxos) e usam soquetes TCP/IP. Um canal é usado para enviar mensagens para o membro e o outro canal é usado para receber mensagens do membro. Se um membro não receber mensagens de outro membro por 5 segundos, ele suspeita que o membro falhou e lista o status desse membro como `UNREACHABLE` (IRRECONHECÍVEL) em sua própria tabela do Schema de Desempenho `replication_group_members`. Normalmente, dois membros suspeitarão um do outro de ter falhado porque cada um não está se comunicando com o outro. É possível, embora menos provável, que o membro A suspeite que o membro B falhou, mas o membro B não suspeita que o membro A falhou - talvez devido a um problema de roteamento ou firewall. Um membro também pode criar uma suspeita sobre si mesmo. Um membro que está isolado do resto do grupo suspeita que todos os outros falharam.

Se uma suspeita durar mais de 10 segundos, o membro suspeito tenta propagar sua opinião de que o membro suspeito está com defeito aos outros membros do grupo. Um membro suspeito só faz isso se for um notificador, conforme calculado pelo número do nó XCom interno. Se um membro estiver realmente isolado do resto do grupo, ele pode tentar propagar sua opinião, mas isso não terá consequências, pois não consegue garantir um quórum dos outros membros para concordarem com isso. Uma suspeita só tem consequências se um membro for um notificador e sua suspeita durar o tempo suficiente para ser propagada aos outros membros do grupo, e os outros membros concordarem com isso. Nesse caso, o membro suspeito é marcado para expulsão do grupo em uma decisão coordenada, e é expulso após o período de espera definido pela variável de sistema `group_replication_member_expel_timeout` expirar e o mecanismo de expulsão detectar e implementar a expulsão.

Quando a rede é instável e os membros frequentemente perdem e recuperam a conexão uns com os outros em diferentes combinações, é teoricamente possível que um grupo termine marcando todos os seus membros para expulsão, após o que o grupo deixaria de existir e teria que ser recriado. Para contrariar essa possibilidade, o Sistema de Comunicação de Grupo de Replicação de Grupos (GCS) rastreia os membros do grupo que foram marcados para expulsão e os trata como se estivessem no grupo de membros suspeitos ao decidir se há uma maioria. Isso garante que pelo menos um membro permaneça no grupo e o grupo possa continuar a existir. Quando um membro expulso realmente é removido do grupo, o GCS remove seu registro de ter marcado o membro para expulsão, para que o membro possa se juntar ao grupo novamente, se conseguir.

Para obter informações sobre as variáveis do sistema de replicação em grupo que você pode configurar para especificar as respostas dos membros do grupo de trabalho em situações de falha, e as ações tomadas pelos membros do grupo que são suspeitos de terem falhado, consulte a Seção 20.7.7, “Respostas à Detecção de Falha e Partição de Rede”.