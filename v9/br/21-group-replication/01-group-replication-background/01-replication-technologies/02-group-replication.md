#### 20.1.1.2 Replicação em Grupo

A Replicação em Grupo é uma técnica que pode ser usada para implementar sistemas resistentes a falhas. Um grupo de replicação é um conjunto de servidores, cada um dos quais possui uma cópia completa dos dados (um esquema de replicação sem nada compartilhado), que interagem entre si por meio da passagem de mensagens. A camada de comunicação fornece um conjunto de garantias, como entrega de mensagens atômicas e mensagens de ordem total. Essas são propriedades muito poderosas que se traduzem em abstrações muito úteis que podem ser usadas para construir soluções de replicação de banco de dados mais avançadas.

A Replicação em Grupo do MySQL é baseada nessas propriedades e abstrações e implementa um protocolo de replicação de atualização de múltiplas fontes em todos os lugares. Um grupo de replicação é formado por vários servidores; cada servidor no grupo pode executar transações de forma independente a qualquer momento. As transações de leitura/escrita são confirmadas apenas após serem aprovadas pelo grupo. Em outras palavras, para qualquer transação de leitura/escrita, o grupo precisa decidir se a confirma ou não, então a operação de confirmação não é uma decisão unilateral do servidor de origem. As transações de leitura apenas não precisam de coordenação dentro do grupo e são confirmadas imediatamente.

Quando uma transação de leitura/escrita está pronta para ser confirmada no servidor de origem, o servidor transmite ativamente os valores de escrita (as linhas que foram alteradas) e o conjunto de escrita correspondente (os identificadores únicos das linhas que foram atualizadas). Como a transação é enviada por meio de uma transmissão atômica, todos os servidores do grupo recebem a transação ou nenhum deles. Se eles a receberem, todos receberão a transação na mesma ordem em relação às outras transações enviadas anteriormente. Portanto, todos os servidores recebem o mesmo conjunto de transações na mesma ordem, e uma ordem total global é estabelecida para as transações.

No entanto, podem ocorrer conflitos entre transações que são executadas simultaneamente em diferentes servidores. Esses conflitos são detectados ao inspecionar e comparar os conjuntos de escrita de duas transações diferentes e simultâneas, em um processo chamado *certificação*. Durante a certificação, a detecção de conflitos é realizada a nível de linha: se duas transações simultâneas, que foram executadas em diferentes servidores, atualizam a mesma linha, então há um conflito. O procedimento de resolução de conflitos afirma que a transação que foi ordenada primeiro é confirmada em todos os servidores, e a transação ordenada em segundo lugar é abortada e, portanto, desfeita no servidor de origem e descartada pelos outros servidores do grupo. Por exemplo, se t1 e t2 são executadas simultaneamente em diferentes sites, ambas alterando a mesma linha, e t2 é ordenada antes de t1, então t2 vence o conflito e t1 é desfeita. Isso é, na verdade, uma regra de primeiro conflito distribuído. Note que, se duas transações estiverem mais frequentemente ligadas a conflitos, é uma boa prática iniciá-las no mesmo servidor, onde elas têm a chance de se sincronizar no gerenciador de bloqueio local em vez de serem desfeitas como resultado da certificação.

Para aplicar e externalizar as transações certificadas, o Grupo de Replicação permite que os servidores se desviem da ordem acordada das transações, desde que isso não viole a consistência e a validade. O Grupo de Replicação é um sistema de consistência eventual, o que significa que, assim que o tráfego de entrada desacelera ou para, todos os membros do grupo têm o mesmo conteúdo de dados. Enquanto o tráfego está fluindo, as transações podem ser externalizadas em uma ordem ligeiramente diferente ou externalizadas em alguns membros antes dos outros. Por exemplo, no modo multi-primário, uma transação local pode ser externalizada imediatamente após a certificação, embora uma transação remota que está mais cedo na ordem global ainda não tenha sido aplicada. Isso é permitido quando o processo de certificação estabelece que não há conflito entre as transações. No modo único-primário, no servidor primário, há uma pequena chance de que transações locais concorrentes e não conflitantes possam ser confirmadas e externalizadas em uma ordem diferente da ordem global acordada pelo Grupo de Replicação. Nos secundários, que não aceitam escritas de clientes, as transações são sempre confirmadas e externalizadas na ordem acordada.

A figura a seguir ilustra o protocolo de Grupo de Replicação do MySQL e, ao compará-lo com a Replicação do MySQL (ou até mesmo a replicação semisoincronizada do MySQL), você pode ver algumas diferenças. Algumas mensagens relacionadas a consenso e Paxos subjacentes estão ausentes desta imagem para fins de clareza.

**Figura 20.3 Protocolo de Grupo de Replicação do MySQL**

![Uma transação recebida pela Fonte 1 é executada. A Fonte 1, em seguida, envia uma mensagem para o grupo de replicação, que consiste em si mesma, a Fonte 2 e a Fonte 3. Quando todos os três membros alcançam o consenso, eles certificam a transação. A Fonte 1, então, escreve a transação em seu log binário, a confirma e envia uma resposta para o aplicativo cliente. As Fontes 2 e 3 escrevem a transação em seus logs de retransmissão, a aplicam, a escrevem no log binário e a confirmam.](images/gr-replication-diagram.png)