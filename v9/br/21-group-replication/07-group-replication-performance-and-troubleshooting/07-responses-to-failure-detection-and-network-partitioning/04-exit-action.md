#### 20.7.7.4 Ação de Saída

A variável de sistema `group_replication_exit_state_action` especifica o que a Replicação em Grupo faz quando o membro sai do grupo acidentalmente devido a um erro ou problema, e não consegue se reiniciar automaticamente ou não tenta. Note que, no caso de um membro expulso, o membro não sabe que foi expulso até se reconectar ao grupo, então a ação especificada é realizada apenas se o membro conseguir se reconectar ou se o membro levantar uma suspeita sobre si mesmo e se expulsar.

Em ordem de impacto, as ações de saída são as seguintes:

1. Se `READ_ONLY` for a ação de saída, a instância muda o MySQL para o modo de leitura super-somente, configurando a variável de sistema `super_read_only` para `ON`. Quando o membro está no modo de leitura super-somente, os clientes não podem fazer nenhuma atualização, mesmo que tenham o privilégio `CONNECTION_ADMIN` (ou o privilégio `SUPER` desatualizado). No entanto, os clientes ainda podem ler os dados, e, como as atualizações não estão sendo feitas mais, há uma probabilidade de leituras desatualizadas que aumenta com o tempo. Com essa configuração, você precisa monitorar os servidores de forma proativa para detectar falhas. Essa ação de saída é a padrão; após ser realizada, o status do membro é exibido como `ERROR` na visualização do grupo.

2. Se `OFFLINE_MODE` for a ação de saída, a instância desativa o MySQL para o modo offline, configurando a variável de sistema `offline_mode` para `ON`. Quando o membro estiver no modo offline, os usuários clientes conectados serão desconectados na próxima solicitação e as conexões não serão mais aceitas, com exceção dos usuários clientes que possuem o privilégio `CONNECTION_ADMIN` (ou o desatualizado `SUPER`). A Replicação de Grupo também configura a variável de sistema `super_read_only` para `ON`, para que os clientes não possam fazer quaisquer atualizações, mesmo que tenham se conectado com o privilégio `CONNECTION_ADMIN` ou `SUPER`. Essa ação de saída impede tanto as atualizações quanto as leituras obsoletas (com exceção das leituras pelos usuários clientes com os privilégios declarados), e habilita ferramentas de proxy, como o MySQL Router, para reconhecer que o servidor está indisponível e redirecionar as conexões dos clientes. Também deixa a instância em execução para que um administrador possa tentar resolver o problema sem desligar o MySQL. Após essa ação de saída ser realizada, o status do membro é exibido como `ERROR` na visualização do grupo (não `OFFLINE`, o que significa que o membro tem a funcionalidade de Replicação de Grupo disponível, mas atualmente não pertence a um grupo).

3. Se `ABORT_SERVER` for a ação de saída, a instância desativa o MySQL. Instruir o membro a se desligar impede todas as leituras obsoletas e atualizações dos clientes, mas isso significa que a instância do Servidor MySQL está indisponível e deve ser reiniciada, mesmo que o problema possa ter sido resolvido sem essa etapa. Após essa ação de saída ser realizada, o membro é removido da lista de servidores na visualização do grupo.

Tenha em mente que a intervenção do operador é necessária, independentemente da ação de saída definida, pois um ex-membro que esgotou suas tentativas de auto-reinserção (ou nunca as teve) e foi expulso do grupo não pode se reinserir sem o reinício da Replicação do Grupo. A ação de saída só influencia se os clientes ainda podem ler dados no servidor que não conseguiu se reinserir no grupo e se o servidor continua funcionando.

Importante

Se uma falha ocorrer antes que o membro tenha se unido com sucesso ao grupo, a ação de saída especificada por `group_replication_exit_state_action` *não é realizada*. Esse é o caso se houver uma falha durante a verificação de configuração local ou uma incompatibilidade entre a configuração do membro que está se juntando e a configuração do grupo. Nessas situações, a variável de sistema `super_read_only` é deixada com seu valor original, e o servidor não desliga o MySQL. Para garantir que o servidor não possa aceitar atualizações quando a Replicação do Grupo não foi iniciada, recomendamos que `super_read_only=ON` seja definido no arquivo de configuração do servidor ao iniciar, o que a Replicação do Grupo altera para `OFF` nos membros primários após ser iniciada com sucesso. Essa proteção é particularmente importante quando o servidor é configurado para iniciar a Replicação do Grupo no inicialização do servidor (`group_replication_start_on_boot=ON`), mas também é útil quando a Replicação do Grupo é iniciada manualmente usando uma declaração `START GROUP_REPLICATION`.

Se uma falha ocorrer após o membro ter se unido com sucesso ao grupo, a ação de saída especificada é realizada. Esse é o caso nas seguintes situações:

1. *Erro do aplicável* - Há um erro no aplicável de replicação. Esse problema não é recuperável.

2. *Recuperação distribuída não possível* - Há um problema que impede o processo de recuperação distribuída da Replicação em Grupo (que utiliza operações de clonagem remota e transferência de estado do log binário) de ser concluído. A Replicação em Grupo tenta a recuperação distribuída automaticamente quando isso faz sentido, mas para de tentar se houver mais nenhuma opção para concluir o processo. Para detalhes, consulte a Seção 20.5.4.4, “Tolerância a Falhas para Recuperação Distribuída”.

3. *Erro de alteração de configuração do grupo* - Um erro ocorreu durante uma alteração de configuração em todo o grupo realizada usando uma função, conforme descrito na Seção 20.5.1, “Configurando um Grupo Online”.

4. *Erro de eleição primária* - Um erro ocorreu durante a eleição de um novo membro primário para um grupo no modo de única primária, conforme descrito na Seção 20.1.3.1, “Modo de Única Primária”.

5. *Timeout de maioria inatingível* - O membro perdeu contato com a maioria dos membros do grupo, está em minoria, e o timeout definido pela variável de sistema `group_replication_unreachable_majority_timeout` expirou.

6. *Membro expulso do grupo* - Uma suspeita foi levantada sobre o membro, e o timeout definido pela variável de sistema `group_replication_member_expel_timeout` expirou, e o membro retomou a comunicação com o grupo e descobriu que foi expulso.

7. *Fora das tentativas de reinclusão automática* - A variável de sistema `group_replication_autorejoin_tries` foi definida para especificar um número de tentativas de reinclusão automática após a perda da maioria ou expulsão, e o membro completou esse número de tentativas sem sucesso.

A tabela a seguir resume os cenários de falha e as ações em cada caso:

**Tabela 20.3 Ações de saída em situações de falha da Replicação em Grupo**

<table frame="all" summary="Resume como a ação de saída selecionada funciona ou não, dependendo da situação de falha"><col align="left" style="width: 33%"/><col align="left" style="width: 33%"/><col align="left" style="width: 33%"/><thead><tr> <th scope="col"><p> Situação de falha </p></th> <th scope="col"><p> Replicação em grupo iniciada com <code class="literal">START GROUP_REPLICATION</code> </p></th> <th scope="col"><p> Replicação em grupo iniciada com <code class="literal">group_replication_start_on_boot =ON</code> </p></th> </tr></thead><tbody><tr> <th><p> Membro falha na verificação de configuração local </p><p> Desajuste entre o membro que está se juntando e a configuração do grupo </p></th> <td><p> <code class="literal">super_read_only</code> e <code class="literal">offline_mode</code> inalterados </p><p> O MySQL continua em execução </p><p> Defina <code class="literal">super_read_only=ON</code> na inicialização para impedir atualizações </p></td> <td><p> <code class="literal">super_read_only</code> e <code class="literal">offline_mode</code> inalterados </p><p> O MySQL continua em execução </p><p> Defina <code class="literal">super_read_only=ON</code> na inicialização para impedir atualizações (Importante) </p></td> </tr><tr> <th><p> Erro de aplicável no membro </p><p> Recuperação distribuída não possível </p><p> Erro de alteração da configuração do grupo </p><p> Erro de eleição primária </p><p> Timeout de maioria inatingível </p><p> Membro expulso do grupo </p><p> Fora de tentativas de reinclusão automática </p></th> <td><p> <code class="literal">super_read_only</code> definido como <code class="literal">ON</code> </p><p> OU </p><p> <code class="literal">offline_mode</code> e <code class="literal">super_read_only</code> definidos como <code class="literal">ON</code> </p><p> OU </p><p> O MySQL é desligado </p></td> <td><p> <code class="literal">super_read_only</code> definido como <code class="literal">ON</code> </p><p> OU </p><p> <code class="literal">offline_mode</code> e <code class="literal">super_read_only</code> definidos como <code class="literal">ON</code> </p><p> OU </p><p> O MySQL é desligado </p></td> </tr></tbody></table>