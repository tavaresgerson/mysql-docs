#### 20.5.4.1 Conexões para Recuperação Distribuída

Quando um membro associado se conecta a um membro existente online para transferência de estado durante a recuperação distribuída, o membro associado atua como cliente na conexão e o membro existente atua como servidor. Quando a transferência de estado do log binário do doador está em andamento nesta conexão (usando o canal de replicação assíncrona `group_replication_recovery`), o membro associado atua como replica e o membro existente atua como fonte. Quando uma operação de clonagem remota está em andamento nesta conexão, o membro associado atua como destinatário e o membro existente atua como doador. As configurações que se aplicam a esses papéis fora do contexto da Replicação em Grupo também podem ser aplicadas para a Replicação em Grupo, a menos que sejam sobrescritas por uma configuração ou comportamento específico da Replicação em Grupo.

A conexão que um membro existente oferece a um membro associado para recuperação distribuída não é a mesma conexão que é usada pela Replicação em Grupo para comunicação entre membros online do grupo.

* A conexão usada pelo motor de comunicação do grupo para a Replicação em Grupo (XCom, uma variante do Paxos) para comunicação TCP entre instâncias XCom remotas é especificada pela variável de sistema `group_replication_local_address`. Esta conexão é usada para mensagens TCP/IP entre membros online. A comunicação com a instância local é feita por meio de um canal de entrada usando memória compartilhada.

* Para a recuperação distribuída, por padrão, os membros do grupo oferecem sua conexão padrão de cliente SQL aos membros associados, conforme especificado por `hostname` e `port`. Se um número de porta alternativo for especificado por `report_port`, este será usado em vez disso.

* Os membros do grupo podem, em vez disso, anunciar uma lista alternativa de pontos finais de recuperação distribuídos como conexões de cliente dedicadas para membros que desejam se juntar, permitindo que você controle o tráfego de recuperação distribuída separadamente das conexões de usuários de cliente regulares do membro. Um membro transmite a lista de pontos finais de recuperação distribuídos especificados por `group_replication_advertise_recovery_endpoints` para o grupo quando ele se junta. Por padrão, o membro continua a oferecer a conexão padrão de cliente SQL, como nas versões anteriores.

Importante

A recuperação distribuída pode falhar se um membro que se junta não puder identificar corretamente os outros membros usando o nome do host conforme definido pela variável de sistema `hostname` do MySQL Server. Recomenda-se que os sistemas operacionais que executam o MySQL tenham um nome de host configurado de forma única, seja usando DNS ou configurações locais. O nome de host que o servidor está usando para conexões de cliente SQL pode ser verificado na coluna `Member_host` da tabela `replication_group_members` do Schema de Desempenho. Se vários membros do grupo externalizarem um nome de host padrão definido pelo sistema operacional, há a chance de o membro que se junta não resolvê-lo para o endereço correto do membro e não conseguir se conectar para a recuperação distribuída. Nessa situação, você pode usar a variável de sistema `report_host` do MySQL Server para configurar um nome de host único a ser externalizado por cada um dos servidores.

Os passos para um membro que se junta estabelecer uma conexão para a recuperação distribuída são os seguintes:

1. Quando o membro se junta ao grupo, ele se conecta com um dos membros de semente incluídos na lista em sua variável de sistema `group_replication_group_seeds`, inicialmente usando a conexão `group_replication_local_address` conforme especificado naquela lista. Os membros de semente podem ser um subconjunto do grupo.

2. Por meio dessa conexão, o membro do grupo usa o serviço de associação do Grupo de Replicação para fornecer ao membro associado uma lista de todos os membros que estão online no grupo, na forma de uma visualização. As informações de associação incluem os detalhes dos pontos finais de recuperação distribuídos ou a conexão padrão do cliente SQL oferecida por cada membro para a recuperação distribuída.

3. O membro associado seleciona um membro do grupo adequado dessa lista para ser seu doador para a recuperação distribuída, seguindo os comportamentos descritos na Seção 20.5.4.4, “Tolerância a Falhas para Recuperação Distribuída”.

4. O membro associado tenta então se conectar ao doador usando os pontos finais de recuperação distribuídos anunciados pelo doador, tentando cada um por sua vez na ordem em que são especificados na lista. Se o doador não fornecer nenhum ponto final, o membro associado tenta se conectar usando a conexão padrão do cliente SQL do doador. Os requisitos de SSL para a conexão são especificados pelas opções `group_replication_recovery_ssl_*` descritas na Seção 20.5.4.1.4, “SSL e Autenticação para Recuperação Distribuída”.

5. Se o membro associado não conseguir se conectar ao doador selecionado, ele tenta novamente com outros membros adequados, seguindo os comportamentos descritos na Seção 20.5.4.4, “Tolerância a Falhas para Recuperação Distribuída”. Observe que, se o membro associado esgota a lista de pontos finais anunciados sem fazer uma conexão, ele não retorna à conexão padrão do cliente SQL do doador, mas passa para outro doador.

6. Quando o membro associado estabelece uma conexão de recuperação distribuída com um doador, ele usa essa conexão para a transferência de estado, conforme descrito na Seção 20.5.4, “Recuperação Distribuída”. O host e o porta para a conexão que é usado são mostrados no log do membro associado. Note que, se uma operação de clonagem remota for usada, quando o membro associado for reiniciado no final da operação, ele estabelece uma conexão com um novo doador para a transferência de estado do log binário. Isso pode ser uma conexão com um membro diferente do doador original usado para a operação de clonagem remota, ou pode ser uma conexão diferente com o doador original. Em qualquer caso, o processo de recuperação distribuída continua da mesma maneira que faria com o doador original.

##### 20.5.4.1.1 Selecionando endereços para pontos finais de recuperação distribuída

Os endereços IP fornecidos pela variável de sistema `group_replication_advertise_recovery_endpoints` como pontos finais de recuperação distribuída não precisam ser configurados para o MySQL Server (ou seja, não precisam ser especificados pela variável de sistema `admin_address` ou na lista para a variável de sistema `bind_address`). Eles precisam ser atribuídos ao servidor. Todos os nomes de host usados devem resolver para um endereço IP local. Endereços IPv4 e IPv6 podem ser usados.

Os porta fornecidos para os pontos finais de recuperação distribuída precisam ser configurados para o MySQL Server, então eles precisam ser especificados pela variável de sistema `port`, `report_port` ou `admin_port`. O servidor deve ouvir conexões TCP/IP nesses porta. Se você especificar a `admin_port`, o usuário de replicação para recuperação distribuída precisa do privilégio `SERVICE_CONNECTION_ADMIN` para se conectar. Selecionar a `admin_port` mantém as conexões de recuperação distribuída separadas das conexões regulares do cliente MySQL.

Os membros do grupo tentam cada um dos pontos finais em ordem, conforme especificados na lista. Se `group_replication_advertise_recovery_endpoints` for definido como `DEFAULT` em vez de uma lista de pontos finais, a conexão padrão do cliente SQL é oferecida. Observe que a conexão padrão do cliente SQL não é incluída automaticamente em uma lista de pontos finais de recuperação distribuídos e não é oferecida como uma opção de fallback se a lista de pontos finais do doador for esgotada sem uma conexão. Se você quiser oferecer a conexão padrão do cliente SQL como um dos vários pontos finais de recuperação distribuídos, você deve incluí-la explicitamente na lista especificada por `group_replication_advertise_recovery_endpoints`. Você pode colocá-la no último lugar para que atue como uma última opção de conexão.

Os pontos finais de recuperação distribuídos de um membro do grupo (ou a conexão padrão do cliente SQL, se os pontos finais não forem fornecidos) não precisam ser adicionados à lista de permissões de replicação de grupo especificada pela variável de sistema `group_replication_ip_allowlist`. A lista de permissões é apenas para o endereço especificado por `group_replication_local_address` para cada membro. Um membro que se junta deve ter sua conexão inicial com o grupo permitida pela lista de permissões para recuperar o endereço ou endereços para recuperação distribuída.

Os pontos finais de recuperação distribuídos que você lista são validados quando a variável de sistema é definida e quando uma instrução `START GROUP_REPLICATION` é emitida. Se a lista não puder ser analisada corretamente ou se algum dos pontos finais não puder ser acessado no host porque o servidor não está ouvindo neles, a replicação de grupo registra um erro e não inicia.

##### 20.5.4.1.2 Compressão para Recuperação Distribuída

Você pode, opcionalmente, configurar a compressão para recuperação distribuída pelo método de transferência de estado de um log binário de um doador. A compressão pode ser benéfica para a recuperação distribuída quando a largura de banda da rede é limitada e o doador precisa transferir muitas transações para o membro que está se juntando. As variáveis de sistema `group_replication_recovery_compression_algorithms` e `group_replication_recovery_zstd_compression_level` determinam os algoritmos de compressão permitidos, e o nível de compressão `zstd` usado ao realizar a transferência de estado de um log binário de um doador. Para mais informações, consulte a Seção 6.2.8, “Controle de Compressão de Conexão”.

Esses ajustes de compressão não se aplicam a operações de clonagem remota. Quando uma operação de clonagem remota é usada para recuperação distribuída, o ajuste do plugin de clonagem para `clone_enable_compression` se aplica.

##### 20.5.4.1.3 Usuário de Replicação para Recuperação Distribuída

A recuperação distribuída requer um usuário de replicação que tenha as permissões corretas para que a Replicação em Grupo possa estabelecer canais de replicação direto de membro para membro. O usuário de replicação também deve ter as permissões corretas para atuar como o usuário de clonagem no doador para uma operação de clonagem remota. O mesmo usuário de replicação deve ser usado para a recuperação distribuída em todos os membros do grupo. Para instruções sobre como configurar esse usuário de replicação, consulte a Seção 20.2.1.3, “Credenciais de Usuário para Recuperação Distribuída”. Para instruções sobre como proteger as credenciais do usuário de replicação, consulte a Seção 20.6.3.1, “Credenciais de Usuário Seguras para Recuperação Distribuída”.

##### 20.5.4.1.4 SSL e Autenticação para Recuperação Distribuída

O SSL para recuperação distribuída é configurado separadamente do SSL para comunicações de grupo normais, o que é determinado pelas configurações de SSL do servidor e pela variável de sistema `group_replication_ssl_mode`. Para conexões de recuperação distribuída, estão disponíveis variáveis de sistema de SSL de recuperação distribuída do Grupo de Replicação dedicadas para configurar o uso de certificados e cifrações especificamente para a recuperação distribuída.

Por padrão, o SSL não é usado para conexões de recuperação distribuída. Para ativá-lo, configure `group_replication_recovery_use_ssl=ON` e configure as variáveis de sistema de SSL de recuperação distribuída do Grupo de Replicação conforme descrito na Seção 20.6.3, “Segurança de Conexões de Recuperação Distribuída”. Você precisa de um usuário de replicação configurado para usar SSL.

Quando a recuperação distribuída é configurada para usar SSL, o Grupo de Replicação aplica essa configuração para operações de clonagem remota, bem como para a transferência de estado de um log binário de um doador. O Grupo de Replicação configura automaticamente as configurações para as opções SSL de clonagem (`clone_ssl_ca`, `clone_ssl_cert` e `clone_ssl_key`) para corresponder às suas configurações para as opções correspondentes de recuperação distribuída do Grupo de Replicação (`group_replication_recovery_ssl_ca`, `group_replication_recovery_ssl_cert` e `group_replication_recovery_ssl_key`).

Se você não estiver usando SSL para recuperação distribuída (portanto, `group_replication_recovery_use_ssl` está definido como `OFF`), e a conta de usuário de replicação do Grupo de Replicação autentica com o plugin `caching_sha2_password` (o padrão) ou o plugin `sha256_password` (desatualizado), pares de chaves RSA são usados para a troca de senhas. Nesse caso, use a variável de sistema `group_replication_recovery_public_key_path` para especificar o arquivo de chave pública RSA ou a variável de sistema `group_replication_recovery_get_public_key` para solicitar a chave pública da fonte, conforme descrito na Seção 20.6.3.1.1, “Usuário de Replicação com o Plugin de Autenticação Caching SHA-2”.