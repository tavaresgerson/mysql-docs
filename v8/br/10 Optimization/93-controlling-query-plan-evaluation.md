### 10.9.1 Controle da Avaliação do Plano de Consulta

A tarefa do otimizador de consultas é encontrar um plano ótimo para executar uma consulta SQL. Como a diferença de desempenho entre os planos "bom" e "ruim" pode ser de ordens de grandeza (ou seja, segundos contra horas ou até dias), a maioria dos otimizadores de consultas, incluindo o do MySQL, realiza uma busca mais ou menos exaustiva por um plano ótimo entre todos os possíveis planos de avaliação de consultas. Para consultas de junção, o número de planos possíveis investigados pelo otimizador do MySQL cresce exponencialmente com o número de tabelas referenciadas em uma consulta. Para um pequeno número de tabelas (tipicamente menos de 7 a 10), isso não é um problema. No entanto, quando consultas maiores são enviadas, o tempo gasto na otimização da consulta pode facilmente se tornar o principal gargalo no desempenho do servidor.

Um método mais flexível para a otimização de consultas permite que o usuário controle o quão exaustivo o otimizador é em sua busca por um plano ótimo de avaliação de consulta. A ideia geral é que, quanto menos planos forem investigados pelo otimizador, menos tempo ele gastará compilando uma consulta. Por outro lado, como o otimizador ignora alguns planos, ele pode perder a oportunidade de encontrar um plano ótimo.

O comportamento do otimizador em relação ao número de planos que ele avalia pode ser controlado usando duas variáveis de sistema:

* A variável `optimizer_prune_level` indica ao otimizador para ignorar certos planos com base nas estimativas do número de linhas acessadas para cada tabela. Nossa experiência mostra que esse tipo de "gasto inteligente" raramente deixa de encontrar planos ótimos e pode reduzir drasticamente os tempos de compilação das consultas. É por isso que essa opção está ativada (`optimizer_prune_level=1`) por padrão. No entanto, se você acredita que o otimizador perdeu um plano de consulta melhor, essa opção pode ser desativada (`optimizer_prune_level=0`) com o risco de que a compilação da consulta possa levar muito mais tempo. Note que, mesmo com o uso dessa heurística, o otimizador ainda explora um número aproximadamente exponencial de planos.
* A variável `optimizer_search_depth` indica até que ponto no "futuro" de cada plano incompleto o otimizador deve procurar para avaliar se ele deve ser expandido ainda mais. Valores menores de `optimizer_search_depth` podem resultar em tempos de compilação de consultas de ordens de magnitude menores. Por exemplo, consultas com 12, 13 ou mais tabelas podem facilmente exigir horas e até dias para serem compiladas se `optimizer_search_depth` estiver próximo ao número de tabelas na consulta. Ao mesmo tempo, se compiladas com `optimizer_search_depth` igual a 3 ou 4, o otimizador pode compilar em menos de um minuto para a mesma consulta. Se você não tem certeza do valor razoável para `optimizer_search_depth`, essa variável pode ser definida como 0 para indicar ao otimizador que ele determine o valor automaticamente.