### 10.5.4 Otimizando o Registro de Redo

Considere as seguintes diretrizes para otimizar o registro de redo:

* Aumente o tamanho dos arquivos de registro de redo. Quando o `InnoDB` preenche completamente os arquivos de registro de redo, ele deve gravar o conteúdo modificado do pool de buffers no disco em um checkpoint. Arquivos de registro de redo pequenos causam muitos escritos desnecessários no disco.
  O tamanho do arquivo de registro de redo é determinado por `innodb_redo_log_capacity`. O `InnoDB` tenta manter 32 arquivos de registro de redo do mesmo tamanho, com cada arquivo igual a 1/32 * `innodb_redo_log_capacity`. Portanto, alterar o ajuste `innodb_redo_log_capacity` altera o tamanho dos arquivos de registro de redo.
  Para obter informações sobre como modificar a configuração do arquivo de registro de redo, consulte a Seção 17.6.5, “Registro de Redo”.
* Considere aumentar o tamanho do buffer de log. Um buffer de log grande permite que transações grandes sejam executadas sem a necessidade de gravar o log no disco antes do commit das transações. Assim, se você tiver transações que atualizam, inserem ou excluem muitas linhas, aumentar o tamanho do buffer de log economiza I/O no disco. O tamanho do buffer de log é configurado usando a opção de configuração `innodb_log_buffer_size`, que pode ser configurada dinamicamente.
* Configure a opção de configuração `innodb_log_write_ahead_size` para evitar o “leitura na escrita”. Esta opção define o tamanho do bloco de pré-escrita para o registro de redo. Defina `innodb_log_write_ahead_size` para corresponder ao tamanho do bloco de cache do sistema operacional ou do sistema de arquivos. A leitura na escrita ocorre quando os blocos de registro de redo não são completamente cacheados no sistema operacional ou no sistema de arquivos devido a uma incompatibilidade entre o tamanho do bloco de pré-escrita para o registro de redo e o tamanho do bloco de cache do sistema operacional ou do sistema de arquivos.

Os valores válidos para `innodb_log_write_ahead_size` são múltiplos do tamanho do bloco do arquivo de log do `InnoDB` (2n). O valor mínimo é o tamanho do bloco do arquivo de log do `InnoDB` (512). A escrita antecipada não ocorre quando o valor mínimo é especificado. O valor máximo é igual ao valor de `innodb_page_size`. Se você especificar um valor para `innodb_log_write_ahead_size` que é maior que o valor de `innodb_page_size`, o ajuste `innodb_log_write_ahead_size` é truncado para o valor de `innodb_page_size`.

Definir o valor de `innodb_log_write_ahead_size` muito baixo em relação ao tamanho do bloco do cache do sistema operacional ou do sistema de arquivos resulta em leitura durante a escrita. Definir o valor muito alto pode ter um pequeno impacto no desempenho do `fsync` para escritas de arquivos de log devido a vários blocos sendo escritos de uma vez.
* O MySQL fornece threads de escritor de log dedicados para escrever registros de log redo do buffer de log para os buffers do sistema e para esvaziar os buffers do sistema para os arquivos de log redo. Você pode habilitar ou desabilitar os threads de escritor de log usando a variável `innodb_log_writer_threads`. Threads de escritor de log dedicados podem melhorar o desempenho em sistemas de alta concorrência, mas para sistemas de baixa concorrência, desabilitar os threads de escritor de log dedicados proporciona um melhor desempenho.
* Otimize o uso do atraso de rotação por threads do usuário esperando por redo esvaziado. O atraso de rotação ajuda a reduzir a latência. Durante períodos de baixa concorrência, reduzir a latência pode ser menos uma prioridade, e evitar o uso do atraso de rotação durante esses períodos pode reduzir o consumo de energia. Durante períodos de alta concorrência, você pode querer evitar gastar poder de processamento no atraso de rotação para que ele possa ser usado para outros trabalhos. As seguintes variáveis de sistema permitem definir valores de nível máximo e mínimo que definem limites para o uso do atraso de rotação.

+ `innodb_log_wait_for_flush_spin_hwm`: Define o tempo médio máximo de esvaziamento do log após o qual os threads do usuário não retornam a girar enquanto aguardam o esvaziamento redo esvaziado. O valor padrão é de 400 microsegundos.
  + `innodb_log_spin_cpu_abs_lwm`: Define a quantidade mínima de uso de CPU abaixo da qual os threads do usuário não retornam a girar enquanto aguardam o esvaziamento redo esvaziado. O valor é expresso como a soma do uso de núcleos de CPU. Por exemplo, o valor padrão de 80 é 80% de um único núcleo de CPU. Em um sistema com um processador multi-core, um valor de 150 representa 100% de uso de um núcleo de CPU mais 50% de uso de um segundo núcleo de CPU.
  + `innodb_log_spin_cpu_pct_hwm`: Define a quantidade máxima de uso de CPU acima da qual os threads do usuário não retornam a girar enquanto aguardam o esvaziamento redo esvaziado. O valor é expresso como uma porcentagem do poder de processamento total combinado de todos os núcleos de CPU. O valor padrão é de 50%. Por exemplo, o uso de 100% de dois núcleos de CPU é de 50% do poder de processamento combinado de CPU em um servidor com quatro núcleos de CPU.

A opção de configuração `innodb_log_spin_cpu_pct_hwm` respeita a afinidade do processador. Por exemplo, se um servidor tem 48 núcleos, mas o processo `mysqld` está fixado apenas em quatro núcleos de CPU, os outros 44 núcleos de CPU são ignorados.